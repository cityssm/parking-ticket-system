"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),(()=>{var t,e;const n="true"===(null===(t=document.querySelector("main"))||void 0===t?void 0:t.dataset.canUpdate);let a=exports.currentBatch;delete exports.currentBatch;let s=exports.convictableTickets;delete exports.convictableTickets;const c=document.querySelector("#filter--parkingTicket"),i=document.querySelector("#convictable-tickets-container");let o=[];function l(t){var e;t.preventDefault();const n=t.currentTarget;n.setAttribute("disabled","disabled");const c=Number.parseInt(null!==(e=n.dataset.index)&&void 0!==e?e:"-1",10),i=s[c].ticketId;cityssm.postJSON("/tickets/doAddTicketToConvictionBatch",{batchId:a.batchId,ticketId:i},t=>{var e;const i=t;i.success?(a=i.batch,g(),s.splice(c,1),d()):(n.removeAttribute("disabled"),bulmaJS.alert({title:"Ticket Not Added",message:null!==(e=i.message)&&void 0!==e?e:"Please try again.",contextualColorName:"danger"}))})}function r(t){let e;t.preventDefault(),cityssm.openHtmlModal("loading",{onshow(){document.querySelector("#is-loading-modal-message").textContent=`Adding ${o.length.toString()}\n          ticket${1===o.length?"":"s"}...`},onshown(t,n){e=n,cityssm.postJSON("/tickets-ontario/doAddAllTicketsToConvictionBatch",{batchId:a.batchId,ticketIds:o},t=>{var n;const c=t;e(),c.batch&&(a=c.batch,g()),c.tickets&&(s=c.tickets,d()),0===c.successCount&&bulmaJS.alert({title:"Results",message:null!==(n=c.message)&&void 0!==n?n:"No tickets were added to the batch.",contextualColorName:"warning"})})}})}function d(){var t,e;if(cityssm.clearElement(i),o=[],!a)return void(i.innerHTML='<div class="message is-warning">\n        <div class="message-body">Select a target batch to get started.</div>\n        </div>');if(!n)return void(i.innerHTML='<div class="message is-warning">\n        <div class="message-body">Parking tickets can only be added by users with update permissions.</div>\n        </div>');if(a.lockDate)return void(i.innerHTML='<div class="message is-warning">\n        <div class="message-body">The target batch is locked and cannot accept additional tickets.</div>\n        </div>');if(0===s.length)return void(i.innerHTML='<div class="message is-info">\n        <div class="message-body">There are no parking tickets currently eligible for conviction.</div>\n        </div>');const d=c.value.trim().toLowerCase(),u=document.createElement("tbody");for(const[n,a]of s.entries()){if(!a.ticketNumber.toLowerCase().includes(d)&&!a.licencePlateNumber.toLowerCase().includes(d))continue;o.push(a.ticketId);const s=document.createElement("tr");s.innerHTML=`<td>\n          <a data-tooltip="View Ticket (Opens in New Window)" href="/tickets/${a.ticketId.toString()}" target="_blank">\n          ${cityssm.escapeHTML(a.ticketNumber)}\n          </a>\n        </td>\n        <td>${a.issueDateString}</td>\n        <td>\n          <span class="licence-plate-number is-size-6">\n          ${cityssm.escapeHTML(a.licencePlateNumber)}\n          </span><br />\n          <span class="has-tooltip-right is-size-7" data-tooltip="Primary Owner">\n          ${cityssm.escapeHTML(null!==(t=a.licencePlateOwner_ownerName1)&&void 0!==t?t:"")}\n          </span>\n        </td>\n        <td class="has-text-right">\n          <button class="button is-small" data-index="${n.toString()}" type="button">\n            <span class="icon is-small"><i class="fas fa-plus" aria-hidden="true"></i></span>\n            <span>Add</span>\n          </button>\n        </td>`,null===(e=s.querySelector("button"))||void 0===e||e.addEventListener("click",l),u.append(s)}if(0===o.length)return void(i.innerHTML='<div class="message is-info">\n        <div class="message-body">There are no parking tickets that meet the search criteria.</div>\n        </div>');const h=document.createElement("button");h.className="button is-fullwidth mb-3",h.innerHTML=`<span class="icon is-small"><i class="fas fa-plus" aria-hidden="true"></i></span>\n      <span>\n        Add ${o.length.toString()}\n        Parking Ticket${1===o.length?"":"s"}\n      </span>`,h.addEventListener("click",r),i.append(h);const m=document.createElement("table");m.className="table is-striped is-hoverable is-fullwidth",m.innerHTML="<thead><tr>\n      <th>Ticket Number</th>\n      <th>Issue Date</th>\n      <th>Licence Plate</th>\n      <th></th>\n      </tr></thead>",m.append(u),i.append(m)}c.addEventListener("keyup",d);const u=document.querySelector("#batch-entries-container");function h(t){var e;t.preventDefault();const n=t.currentTarget;n.setAttribute("disabled","disabled");const c=Number.parseInt(null!==(e=n.dataset.index)&&void 0!==e?e:"-1",10),i=a.batchEntries[c].ticketId;cityssm.postJSON("/tickets-ontario/doRemoveTicketFromConvictionBatch",{batchId:a.batchId,ticketId:i},t=>{const e=t;e.success?(a.batchEntries.splice(c,1),g(),s=e.tickets,d()):n.removeAttribute("disabled")})}function m(t){t.preventDefault(),bulmaJS.confirm({title:"Clear Batch",message:"Are you sure you want to remove all the parking tickets from the batch?",contextualColorName:"warning",okButton:{text:"Yes, Clear the Batch",callbackFunction:function(){cityssm.postJSON("/tickets-ontario/doClearConvictionBatch",{batchId:a.batchId},t=>{var e;const n=t;n.success||cityssm.alertModal("Batch Not Cleared",null!==(e=n.message)&&void 0!==e?e:"","OK","danger"),n.batch&&(a=n.batch,g()),n.tickets&&(s=n.tickets,d())})}}})}function b(){cityssm.postJSON("/tickets/doLockConvictionBatch",{batchId:a.batchId},t=>{const e=t;e.success&&(a.lockDate=e.lockDate,a.lockDateString=e.lockDateString,g(),d())})}function p(t){t.preventDefault(),bulmaJS.confirm({title:"Lock Batch",message:"<strong>Are you sure you want to lock this batch?</strong><br />\n        Once locked, no further changes to the batch will be allowed.\n        The option to download the batch will become available.",messageIsHtml:!0,contextualColorName:"warning",okButton:{text:"Yes, Lock the Batch",callbackFunction:b}})}function v(){cityssm.postJSON("/tickets/doUnlockConvictionBatch",{batchId:a.batchId},t=>{t.success&&(a.lockDate=void 0,a.lockDateString=void 0,g(),d())})}function k(t){t.preventDefault(),bulmaJS.confirm({title:"Unlock Batch",message:"<strong>Are you sure you want to unlock this batch?</strong><br />Once unlocked, changes to the batch will be allowed.",messageIsHtml:!0,contextualColorName:"warning",okButton:{text:"Yes, Unlock the Batch",callbackFunction:v}})}function f(t){var e;function n(){window.open(`/tickets/convict/${a.batchId.toString()}/print`)}t.preventDefault(),-1===(null!==(e=a.sentDate)&&void 0!==e?e:-1)?bulmaJS.confirm({title:"Download Batch",message:"<strong>You are about to download the batch for the first time.</strong><br />\n          Once downloaded, the date will be tracked, and the batch will no longer be able to be unlocked.",messageIsHtml:!0,contextualColorName:"warning",okButton:{text:"Yes, Download the Batch",callbackFunction:function(){cityssm.postJSON("/tickets/doMarkConvictionBatchSent",{batchId:a.batchId},t=>{a=t.batch,g()}),n()}}}):n()}function g(){var t,e,s;if(document.querySelector("#batchSelector--batchId").textContent=`Batch #${a.batchId.toString()}`,document.querySelector("#batchSelector--batchDetails").innerHTML=`<span class="has-tooltip-left" data-tooltip="Batch Date">\n        <span class="icon"><i class="fas fa-star" aria-hidden="true"></i></span>\n        ${a.batchDateString}\n      </span>\n      ${-1===(null!==(t=a.lockDate)&&void 0!==t?t:-1)?"":`<br />\n            <span class="has-tooltip-left" data-tooltip="Lock Date">\n              <span class="icon"><i class="fas fa-lock" aria-hidden="true"></i></span>\n              ${a.lockDateString}\n            </span>`}`,cityssm.clearElement(u),0===a.batchEntries.length)return void(u.innerHTML='<div class="message is-info"><div class="message-body">There are no parking tickets in this batch.</div></div>');const c=document.createElement("tbody"),i=n&&!a.lockDate;for(const[t,n]of(null!==(e=a.batchEntries)&&void 0!==e?e:[]).entries()){const e=document.createElement("tr");e.innerHTML=`<td>\n          <a href="/tickets/${n.ticketId.toString()}" target="_blank">\n            ${n.ticketNumber}\n          </a>\n        </td>\n        <td>${n.issueDateString}</td>\n        <td>\n          <span class="licence-plate-number is-size-6">\n            ${cityssm.escapeHTML(n.licencePlateNumber)}\n          </span>\n        </td>\n        ${i?`<td class="has-text-right">\n              <button class="button is-small" data-index="${t.toString()}" type="button">\n              <span class="icon is-small"><i class="fas fa-minus" aria-hidden="true"></i></span>\n              <span>Remove</span>\n              </button>\n              </td>`:""}`,i&&(null===(s=e.querySelector("button"))||void 0===s||s.addEventListener("click",h)),c.append(e)}const o=document.createElement("table");if(o.className="table is-fullwidth is-striped is-hoverable",o.innerHTML=`<thead><tr>\n      <th>Ticket Number</th>\n      <th>Issue Date</th>\n      <th>Licence Plate</th>\n      ${i?"<th></th>":""}\n      </tr></thead>`,o.append(c),u.append(o),n&&!a.lockDate){const t=document.createElement("button");t.className="button is-fullwidth mb-3",t.innerHTML='<span class="icon is-small">\n        <i class="fas fa-lock" aria-hidden="true"></i>\n        </span>\n        <span>Lock Batch</span>',t.addEventListener("click",p),u.prepend(t);const e=document.createElement("button");e.className="button is-fullwidth mb-3",e.innerHTML='<span class="icon is-small">\n        <i class="fas fa-broom" aria-hidden="true"></i>\n        </span>\n        <span>Clear Batch</span>',e.addEventListener("click",m),o.before(e)}if(n&&a.lockDate&&!a.sentDate){const t=document.createElement("button");t.className="button is-fullwidth mb-3",t.innerHTML='<span class="icon is-small"><i class="fas fa-unlock" aria-hidden="true"></i></span>\n        <span>Unlock Batch</span>',t.addEventListener("click",k),u.prepend(t)}if(a.lockDate){const t=document.createElement("button");t.className="button is-fullwidth mb-3",t.innerHTML='<span class="icon is-small">\n        <i class="fas fa-download" aria-hidden="true"></i>\n        </span>\n        <span>Download Report for Provincial Offences</span>',t.addEventListener("click",f),o.before(t)}}null===(e=document.querySelector("#is-select-batch-button"))||void 0===e||e.addEventListener("click",t=>{let e;function s(t){t.preventDefault();const n=t.currentTarget.dataset.batchId;cityssm.postJSON("/tickets/doGetConvictionBatch",{batchId:n},t=>{a=t,g(),d()}),e()}t.preventDefault(),cityssm.openHtmlModal("mto-selectBatch",{onshow(t){if(n){const n=t.querySelector(".is-create-batch-button");n.classList.remove("is-hidden"),n.addEventListener("click",t=>{t.preventDefault(),e(),bulmaJS.confirm({title:"Create a New Batch",message:"Are you sure you want to create a new conviction batch?",contextualColorName:"info",okButton:{text:"Yes, Create Batch",callbackFunction:function(){cityssm.postJSON("/tickets/doCreateConvictionBatch",{},t=>{const e=t;e.success&&(a=e.batch,g(),d())})}}})})}cityssm.postJSON("/tickets/doGetRecentConvictionBatches",{},e=>{const n=e,a=t.querySelector(".is-results-container");if(cityssm.clearElement(a),0===n.length)return a.className="message is-info",void(a.innerHTML='<div class="message-body">There are no recent conviction batches.</div>');a.className="list is-hoverable";for(const t of n){const e=document.createElement("a");e.className="list-item",e.dataset.batchId=t.batchId.toString(),e.href="#",e.innerHTML=`<div class="columns">\n                  <div class="column is-narrow">#${t.batchId.toString()}</div>\n                  <div class="column has-text-right">\n                  ${t.batchDateString}\n                  ${t.lockDate?'<br />\n                        <div class="tags justify-flex-end">\n                          <span class="tag">\n                            <span class="icon is-small"><i class="fas fa-lock" aria-hidden="true"></i></span>\n                            <span>Locked</span>\n                          </span>\n                        </div>':""}</div>\n                </div>`,e.addEventListener("click",s),a.append(e)}})},onshown(t,n){e=n}})}),a&&g(),d()})();