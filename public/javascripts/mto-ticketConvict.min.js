"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),(()=>{var t;const e="true"===document.querySelectorAll("main")[0].dataset.canUpdate;let a=exports.currentBatch;delete exports.currentBatch;let s=exports.convictableTickets;delete exports.convictableTickets;const n=document.querySelector("#filter--parkingTicket"),c=document.querySelector("#convictable-tickets-container");let i=[];function o(t){var e;t.preventDefault();const n=t.currentTarget;n.setAttribute("disabled","disabled");const c=Number.parseInt(null!==(e=n.dataset.index)&&void 0!==e?e:"-1",10),i=s[c].ticketId;cityssm.postJSON("/tickets/doAddTicketToConvictionBatch",{batchId:a.batchId,ticketId:i},t=>{t.success?(a=t.batch,v(),s.splice(c,1),l()):(n.removeAttribute("disabled"),cityssm.alertModal("Ticket Not Added",t.message,"OK","danger"))})}function r(t){let e;t.preventDefault(),cityssm.openHtmlModal("loading",{onshow(){document.querySelector("#is-loading-modal-message").textContent=`Adding ${i.length.toString()}\n          ticket${1===i.length?"":"s"}...`},onshown(t,n){e=n,cityssm.postJSON("/tickets-ontario/doAddAllTicketsToConvictionBatch",{batchId:a.batchId,ticketIds:i},t=>{var n;e(),t.batch&&(a=t.batch,v()),t.tickets&&(s=t.tickets,l()),0===t.successCount&&cityssm.alertModal("Results",null!==(n=t.message)&&void 0!==n?n:"No tickets were added to the batch.","OK","warning")})}})}function l(){var t,l;if(cityssm.clearElement(c),i=[],!a)return void(c.innerHTML='<div class="message is-warning">\n        <div class="message-body">Select a target batch to get started.</div>\n        </div>');if(!e)return void(c.innerHTML='<div class="message is-warning">\n        <div class="message-body">Parking tickets can only be added by users with update permissions.</div>\n        </div>');if(a.lockDate)return void(c.innerHTML='<div class="message is-warning">\n        <div class="message-body">The target batch is locked and cannot accept additional tickets.</div>\n        </div>');if(0===s.length)return void(c.innerHTML='<div class="message is-info">\n        <div class="message-body">There are no parking tickets currently eligible for conviction.</div>\n        </div>');const d=n.value.trim().toLowerCase(),h=document.createElement("tbody");for(const[e,a]of s.entries()){if(!a.ticketNumber.toLowerCase().includes(d)&&!a.licencePlateNumber.toLowerCase().includes(d))continue;i.push(a.ticketId);const s=document.createElement("tr");s.innerHTML='<td><a data-tooltip="View Ticket (Opens in New Window)" href="/tickets/'+a.ticketId.toString()+'" target="_blank">'+cityssm.escapeHTML(a.ticketNumber)+"</a></td><td>"+a.issueDateString+'</td><td><span class="licence-plate-number is-size-6">'+cityssm.escapeHTML(a.licencePlateNumber)+'</span><br /><span class="has-tooltip-right is-size-7" data-tooltip="Primary Owner">'+cityssm.escapeHTML(null!==(t=a.licencePlateOwner_ownerName1)&&void 0!==t?t:"")+'</span></td><td class="has-text-right"><button class="button is-small" data-index="'+e.toString()+'" type="button"><span class="icon is-small"><i class="fas fa-plus" aria-hidden="true"></i></span><span>Add</span></button></td>',null===(l=s.querySelector("button"))||void 0===l||l.addEventListener("click",o),h.append(s)}if(0===i.length)return void(c.innerHTML='<div class="message is-info">\n        <div class="message-body">There are no parking tickets that meet the search criteria.</div>\n        </div>');const u=document.createElement("button");u.className="button is-fullwidth mb-3",u.innerHTML=`<span class="icon is-small"><i class="fas fa-plus" aria-hidden="true"></i></span>\n      <span>\n        Add ${i.length.toString()}\n        Parking Ticket${1===i.length?"":"s"}\n      </span>`,u.addEventListener("click",r),c.append(u);const m=document.createElement("table");m.className="table is-striped is-hoverable is-fullwidth",m.innerHTML="<thead><tr>\n      <th>Ticket Number</th>\n      <th>Issue Date</th>\n      <th>Licence Plate</th>\n      <th></th>\n      </tr></thead>",m.append(h),c.append(m)}n.addEventListener("keyup",l);const d=document.querySelector("#batch-entries-container"),h=t=>{var e;t.preventDefault();const n=t.currentTarget;n.setAttribute("disabled","disabled");const c=Number.parseInt(null!==(e=n.dataset.index)&&void 0!==e?e:"-1",10),i=a.batchEntries[c].ticketId;cityssm.postJSON("/tickets-ontario/doRemoveTicketFromConvictionBatch",{batchId:a.batchId,ticketId:i},t=>{t.success?(a.batchEntries.splice(c,1),v(),s=t.tickets,l()):n.removeAttribute("disabled")})},u=t=>{t.preventDefault();cityssm.confirmModal("Clear Batch","Are you sure you want to remove all the parking tickets from the batch?","Yes, Clear the Batch","warning",()=>{cityssm.postJSON("/tickets-ontario/doClearConvictionBatch",{batchId:a.batchId},t=>{var e;t.success||cityssm.alertModal("Batch Not Cleared",null!==(e=t.message)&&void 0!==e?e:"","OK","danger"),t.batch&&(a=t.batch,v()),t.tickets&&(s=t.tickets,l())})})};function m(t){t.preventDefault(),cityssm.confirmModal("Lock Batch?","<strong>Are you sure you want to lock this batch?</strong><br />Once locked, no further changes to the batch will be allowed. The option to download the batch will become available.","Yes, Lock the Batch","warning",function(){cityssm.postJSON("/tickets/doLockConvictionBatch",{batchId:a.batchId},t=>{t.success&&(a.lockDate=t.lockDate,a.lockDateString=t.lockDateString,v(),l())})})}function b(t){t.preventDefault(),cityssm.confirmModal("Lock Batch?","<strong>Are you sure you want to unlock this batch?</strong><br />Once unlocked, changes to the batch will be allowed.","Yes, Unlock the Batch","warning",function(){cityssm.postJSON("/tickets/doUnlockConvictionBatch",{batchId:a.batchId},t=>{t.success&&(a.lockDate=void 0,a.lockDateString=void 0,v(),l())})})}function p(t){function e(){window.open(`/tickets/convict/${a.batchId.toString()}/print`)}t.preventDefault(),a.sentDate?e():cityssm.confirmModal("Download Batch","<strong>You are about to download the batch for the first time.</strong><br />Once downloaded, the date will be tracked, and the batch will no longer be able to be unlocked.","Yes, Download the Batch","warning",()=>{cityssm.postJSON("/tickets/doMarkConvictionBatchSent",{batchId:a.batchId},t=>{a=t.batch,v()}),e()})}function v(){var t;if(document.querySelector("#batchSelector--batchId").textContent="Batch #"+a.batchId.toString(),document.querySelector("#batchSelector--batchDetails").innerHTML='<span class="has-tooltip-left" data-tooltip="Batch Date"><span class="icon"><i class="fas fa-star" aria-hidden="true"></i></span> '+a.batchDateString+"</span>"+(a.lockDate?'<br /><span class="has-tooltip-left" data-tooltip="Lock Date"><span class="icon"><i class="fas fa-lock" aria-hidden="true"></i></span> '+a.lockDateString+"</span>":""),cityssm.clearElement(d),0===a.batchEntries.length)return void(d.innerHTML='<div class="message is-info"><div class="message-body">There are no parking tickets in this batch.</div></div>');const s=document.createElement("tbody"),n=e&&!a.lockDate;for(const[e,c]of a.batchEntries.entries()){const a=document.createElement("tr");a.innerHTML='<td><a href="/tickets/'+c.ticketId.toString()+'" target="_blank">'+c.ticketNumber+"</a></td><td>"+c.issueDateString+'</td><td><span class="licence-plate-number is-size-6">'+cityssm.escapeHTML(c.licencePlateNumber)+"</span></td>"+(n?'<td class="has-text-right"><button class="button is-small" data-index="'+e.toString()+'" type="button"><span class="icon is-small"><i class="fas fa-minus" aria-hidden="true"></i></span><span>Remove</span></button></td>':""),n&&(null===(t=a.querySelector("button"))||void 0===t||t.addEventListener("click",h)),s.append(a)}const c=document.createElement("table");if(c.className="table is-fullwidth is-striped is-hoverable",c.innerHTML=`<thead><tr>\n      <th>Ticket Number</th>\n      <th>Issue Date</th>\n      <th>Licence Plate</th>\n      ${n?"<th></th>":""}\n      </tr></thead>`,c.append(s),d.append(c),e&&!a.lockDate){const t=document.createElement("button");t.className="button is-fullwidth mb-3",t.innerHTML='<span class="icon is-small">\n        <i class="fas fa-lock" aria-hidden="true"></i>\n        </span>\n        <span>Lock Batch</span>',t.addEventListener("click",m),d.prepend(t);const e=document.createElement("button");e.className="button is-fullwidth mb-3",e.innerHTML='<span class="icon is-small">\n        <i class="fas fa-broom" aria-hidden="true"></i>\n        </span>\n        <span>Clear Batch</span>',e.addEventListener("click",u),c.before(e)}if(e&&a.lockDate&&!a.sentDate){const t=document.createElement("button");t.className="button is-fullwidth mb-3",t.innerHTML='<span class="icon is-small"><i class="fas fa-unlock" aria-hidden="true"></i></span><span>Unlock Batch</span>',t.addEventListener("click",b),d.prepend(t)}if(a.lockDate){const t=document.createElement("button");t.className="button is-fullwidth mb-3",t.innerHTML='<span class="icon is-small">\n        <i class="fas fa-download" aria-hidden="true"></i>\n        </span>\n        <span>Download Report for Provincial Offences</span>',t.addEventListener("click",p),c.before(t)}}null===(t=document.querySelector("#is-select-batch-button"))||void 0===t||t.addEventListener("click",t=>{let s;function n(t){t.preventDefault();const e=t.currentTarget.dataset.batchId;cityssm.postJSON("/tickets/doGetConvictionBatch",{batchId:e},t=>{a=t,v(),l()}),s()}t.preventDefault(),cityssm.openHtmlModal("mto-selectBatch",{onshow(t){if(e){const e=t.querySelector(".is-create-batch-button");e.classList.remove("is-hidden"),e.addEventListener("click",t=>{t.preventDefault(),s(),cityssm.confirmModal("Create a New Batch","Are you sure you want to create a new conviction batch?","Yes, Create Batch","info",()=>{cityssm.postJSON("/tickets/doCreateConvictionBatch",{},t=>{t.success&&(a=t.batch,v(),l())})})})}cityssm.postJSON("/tickets/doGetRecentConvictionBatches",{},e=>{const a=t.querySelector(".is-results-container");if(cityssm.clearElement(a),0===e.length)return a.className="message is-info",void(a.innerHTML='<div class="message-body">There are no recent conviction batches.</div>');a.className="list is-hoverable";for(const t of e){const e=document.createElement("a");e.className="list-item",e.dataset.batchId=t.batchId.toString(),e.href="#",e.innerHTML='<div class="columns"><div class="column is-narrow">#'+t.batchId.toString()+'</div><div class="column has-text-right">'+t.batchDateString+(t.lockDate?'<br /><div class="tags justify-flex-end"><span class="tag"><span class="icon is-small"><i class="fas fa-lock" aria-hidden="true"></i></span><span>Locked</span></span>':"")+"</div></div>",e.addEventListener("click",n),a.append(e)}})},onshown(t,e){s=e}})}),a&&v(),l()})();