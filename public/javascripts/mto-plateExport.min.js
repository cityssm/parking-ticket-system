"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),(()=>{var e,t,a;const s="true"===(null===(e=document.querySelector("main"))||void 0===e?void 0:e.dataset.canUpdate);let n=-1,i=!0,c=!1,l=!1;const o=document.querySelector("#available--issueDaysAgo"),r=document.querySelector("#is-available-tickets-container"),d=document.querySelector("#available--licencePlateNumber");let u=[],p=[];function m(e){var t;e.preventDefault();const a=e.currentTarget;a.setAttribute("disabled","disabled");const s=Number.parseInt(null!==(t=a.dataset.index)&&void 0!==t?t:"-1",10),i=u[s],c=a.closest(".is-ticket-container");cityssm.postJSON("/plates/doAddLicencePlateToLookupBatch",{batchId:n,licencePlateCountry:"CA",licencePlateProvince:"ON",licencePlateNumber:i.licencePlateNumber,ticketId:i.ticketId},e=>{const t=e;t.success?(c.remove(),u[s]=void 0,L(t.batch)):a.removeAttribute("disabled")})}function b(e){var t;e.preventDefault();const a=e.currentTarget;a.setAttribute("disabled","disabled");const s=Number.parseInt(null!==(t=a.dataset.index)&&void 0!==t?t:"-1",10),i=p[s],c=a.closest(".is-entry-container");cityssm.postJSON("/plates/doRemoveLicencePlateFromLookupBatch",{batchId:n,ticketId:i.ticketId,licencePlateCountry:"CA",licencePlateProvince:"ON",licencePlateNumber:i.licencePlateNumber},e=>{e.success?(c.remove(),g()):a.removeAttribute("disabled")})}function h(e){e.preventDefault(),cityssm.confirmModal("Clear Batch?","Are you sure you want to remove all licence plates from the batch?","Yes, Clear the Batch","warning",function(){cityssm.postJSON("/plates/doClearLookupBatch",{batchId:n},e=>{e.success&&(L(e.batch),g())})})}function v(e){function t(){window.open("/plates-ontario/mtoExport/"+n.toString()),l=!0}e.preventDefault(),l?t():cityssm.confirmModal("Download Batch?","<strong>You are about to download this batch for the first time.</strong><br />The date of this download will be tracked as part of the batch record.","OK, Download the File","warning",t)}function f(){var e;cityssm.clearElement(r);const t=document.createElement("div");t.className="panel";const a=d.value.toLowerCase().trim().split(" "),s=[];for(const[n,i]of u.entries()){if(!i)continue;let c=!0;const l=i.licencePlateNumber.toLowerCase();for(const e of a)if(!l.includes(e)){c=!1;break}if(!c)continue;s.push(i.ticketId);const o=document.createElement("div");o.className="panel-block is-block is-ticket-container",o.innerHTML='<div class="level is-marginless"><div class="level-left"><div class="licence-plate"><div class="licence-plate-number">'+cityssm.escapeHTML(i.licencePlateNumber)+'</div></div></div><div class="level-right"><button class="button is-small" data-index="'+n.toString()+'" data-cy="add-ticket" data-tooltip="Add to Batch" type="button"><span class="icon is-small"><i class="fas fa-plus" aria-hidden="true"></i></span><span>Add</span></button></div></div><div class="level"><div class="level-left"><div class="tags"><a class="tag has-tooltip-bottom" data-tooltip="View Ticket (Opens in New Window)" href="/tickets/'+encodeURIComponent(i.ticketId)+'" target="_blank">'+cityssm.escapeHTML(i.ticketNumber)+'</a></div></div><div class="level-right is-size-7">'+i.issueDateString+"</div></div>",null===(e=o.querySelector("button"))||void 0===e||e.addEventListener("click",m),t.append(o)}if(s.length>0){const e=document.createElement("button");e.className="button is-fullwidth mb-3",e.dataset.cy="add-tickets",e.innerHTML='<span class="icon is-small"><i class="fas fa-plus" aria-hidden="true"></i></span><span>Add '+s.length.toString()+" Parking Ticket"+(1===s.length?"":"s")+"</span>",e.addEventListener("click",()=>{cityssm.openHtmlModal("loading",{onshown(e,t){document.querySelector("#is-loading-modal-message").textContent=`Adding\n              ${s.length.toString()}\n              Parking Ticket${1===s.length?"":"s"}...`,cityssm.postJSON("/plates/doAddAllParkingTicketsToLookupBatch",{batchId:n,ticketIds:s},e=>{t(),e.success&&(L(e.batch),g())})}})}),r.append(e),r.append(t)}else r.innerHTML='<div class="message is-info">\n        <div class="message-body">There are no parking tickets that meet your search criteria.</div>\n        </div>'}function g(){i?r.innerHTML='<div class="message is-info">\n        <div class="message-body">Parking Tickets cannot be added to a locked batch.</div>\n        </div>':(r.innerHTML='<p class="has-text-centered has-text-grey-lighter">\n      <i class="fas fa-3x fa-circle-notch fa-spin" aria-hidden="true"></i><br />\n      <em>Loading parking tickets...</em>\n      </p>',cityssm.postJSON("/plates-ontario/doGetParkingTicketsAvailableForMTOLookup",{batchId:n,issueDaysAgo:o.value},e=>{u=e.tickets,f()}))}null===(t=document.querySelector("#is-more-available-filters-toggle"))||void 0===t||t.addEventListener("click",e=>{var t;e.preventDefault(),null===(t=document.querySelector("#is-more-available-filters"))||void 0===t||t.classList.toggle("is-hidden")}),d.addEventListener("keyup",f),o.addEventListener("change",g);const k=document.querySelector("#is-lock-batch-button"),y=document.querySelector("#is-batch-entries-container");function L(e){var t;if(n=e.batchId,p=e.batchEntries,i=""!==e.lockDateString,l=""!==e.sentDateString,c=e.mto_includeLabels,s&&(i?k.setAttribute("disabled","disabled"):k.removeAttribute("disabled")),document.querySelector("#batchSelector--batchId").innerHTML="Batch #"+e.batchId.toString()+"<br />"+(c?'<span class="tag is-light"><span class="icon is-small"><i class="fas fa-tag" aria-hidden="true"></i></span> <span>Include Labels</span></span>':"")+" "+(i?'<span class="tag is-light"><span class="icon is-small"><i class="fas fa-lock" aria-hidden="true"></i></span> <span>'+e.lockDateString+"</span></span>":""),document.querySelector("#batchSelector--batchDetails").innerHTML='<span class="icon is-small"><i class="fas fa-calendar" aria-hidden="true"></i></span><span>'+e.batchDateString+"</span>",cityssm.clearElement(y),0===p.length)return void(y.innerHTML='<div class="message is-info"><p class="message-body">There are no parking tickets included in the batch.</p></div>');cityssm.clearElement(y);const a=document.createElement("div");a.className="panel";for(const[e,s]of p.entries()){const n=document.createElement("div");n.className="panel-block is-block is-entry-container",n.innerHTML='<div class="level mb-0"><div class="level-left"><div class="licence-plate"><div class="licence-plate-number">'+cityssm.escapeHTML(s.licencePlateNumber)+"</div></div></div>"+(i?"":'<div class="level-right"><button class="button is-small" data-index="'+e.toString()+'" data-cy="remove-ticket" type="button"><span class="icon is-small"><i class="fas fa-minus" aria-hidden="true"></i></span><span>Remove</span></button></div>')+'</div><a class="tag has-tooltip-bottom" data-tooltip="View Ticket (Opens in New Window)" href="/tickets/'+encodeURIComponent(s.ticketId)+'" target="_blank">'+cityssm.escapeHTML(s.ticketNumber)+"</a>",i||null===(t=n.querySelector("button"))||void 0===t||t.addEventListener("click",b),a.append(n)}if(i){const e=document.createElement("button");e.className="button is-fullwidth mb-3",e.innerHTML='<span class="icon is-small"><i class="fas fa-download" aria-hidden="true"></i></span>\n        <span>Download File for MTO</span>',e.addEventListener("click",v),y.append(e),y.insertAdjacentHTML("beforeend",'<a class="button is-fullwidth mb-3" href="https://www.aris.mto.gov.on.ca/edtW/login/login.jsp" target="_blank" rel="noreferrer">\n          <span class="icon is-small"><i class="fas fa-building" aria-hidden="true"></i></span>\n          <span>MTO ARIS Login</span>\n          </a>')}else{const e=document.createElement("button");e.className="button is-fullwidth mb-3",e.dataset.cy="clear-batch",e.innerHTML='<span class="icon is-small"><i class="fas fa-broom" aria-hidden="true"></i></span><span>Clear Batch</span>',e.addEventListener("click",h),y.append(e)}y.append(a)}null===(a=document.querySelector("#is-select-batch-button"))||void 0===a||a.addEventListener("click",function(e){let t,a;function i(e){var a;e.preventDefault(),n=Number.parseInt(null!==(a=e.currentTarget.dataset.batchId)&&void 0!==a?a:"-1",10),t(),cityssm.postJSON("/plates/doGetLookupBatch",{batchId:n},e=>{L(e),g()})}e.preventDefault(),cityssm.openHtmlModal("mto-selectBatch",{onshow(e){if(a=e.querySelector(".is-results-container"),cityssm.postJSON("/plates/doGetUnreceivedLicencePlateLookupBatches",{},e=>{if(0===e.length)return void(a.innerHTML='<div class="message is-info">\n              <p class="message-body">There are no unsent batches available.</p>\n              </div>');const t=document.createElement("div");t.className="panel";for(const a of e){const e=document.createElement("a");e.className="panel-block is-block",e.setAttribute("href","#"),e.dataset.batchId=a.batchId.toString(),e.innerHTML='<div class="columns"><div class="column is-narrow">#'+a.batchId.toString()+'</div><div class="column has-text-right">'+a.batchDateString+'<br /><div class="tags justify-flex-end">'+(a.mto_includeLabels?'<span class="tag"><span class="icon is-small"><i class="fas fa-tag" aria-hidden="true"></i></span><span>Includes Labels</span></span>':"")+(a.lockDate?'<span class="tag"><span class="icon is-small"><i class="fas fa-lock" aria-hidden="true"></i></span><span>Locked</span></span>':"")+(a.sentDate?'<span class="tag"><span class="icon is-small"><i class="fas fa-share" aria-hidden="true"></i></span><span>Sent to MTO</span></span>':"")+"</div></div></div>",e.addEventListener("click",i),t.append(e)}cityssm.clearElement(a),a.append(t)}),s){const a=e.querySelector(".is-create-batch-button");a.classList.remove("is-hidden"),a.addEventListener("click",()=>{t(),function(){let e;function t(t){t.preventDefault();const a=t.currentTarget.dataset.includeLabels;cityssm.postJSON("/plates/doCreateLookupBatch",{mto_includeLabels:a},t=>{t.success&&(e(),L(t.batch),g())})}cityssm.openHtmlModal("mto-createBatch",{onshow:e=>{const a=e.querySelectorAll(".is-create-batch-button");for(const e of a)e.addEventListener("click",t)},onshown:(t,a)=>{e=a}})}()})}},onshown(e,a){t=a}})}),s&&(null==k||k.addEventListener("click",()=>{i||cityssm.confirmModal("Lock Batch?",'<strong>Are you sure you want to lock the batch?</strong><br />Once the batch is locked, no licence plates can be added or deleted from the batch. All tickets related to the licence plates in the batch will be updated with a "Pending Lookup" status.',"Yes, Lock the Batch","info",function(){cityssm.postJSON("/plates/doLockLookupBatch",{batchId:n},e=>{e.success&&L(e.batch)})})})),exports.plateExportBatch&&(L(exports.plateExportBatch),delete exports.plateExportBatch,g())})();