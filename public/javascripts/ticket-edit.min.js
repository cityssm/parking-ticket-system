"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),function(){for(var e=document.getElementById("ticket--ticketID").value,t=""===e,s=document.getElementById("container--form-message"),a=function(){cityssm.enableNavBlocker(),!0,s.innerHTML='<span class="tag is-light is-info is-medium"><span class="icon"><i class="fas fa-exclamation-triangle" aria-hidden="true"></i></span> <span>Unsaved Changes</span></div>'},n=document.querySelectorAll(".input, .select, .textarea"),i=0;i<n.length;i+=1)n[i].addEventListener("change",a);document.getElementById("form--ticket").addEventListener("submit",function(e){e.preventDefault();var n=document.getElementById("ticket--ticketNumber").value;s.innerHTML='<span class="tag is-light is-info is-medium"><span>Saving ticket... </span> <span class="icon"><i class="fas fa-circle-notch fa-spin" aria-hidden="true"></i></span></div>',cityssm.postJSON(t?"/tickets/doCreateTicket":"/tickets/doUpdateTicket",e.currentTarget,function(e){e.success?(cityssm.disableNavBlocker(),!1,s.innerHTML='<span class="tag is-light is-success is-medium"><span class="icon"><i class="fas fa-check" aria-hidden="true"></i></span> <span>Saved Successfully</span></div>'):(a(),cityssm.alertModal("Ticket Not Saved",e.message,"OK","danger")),e.success&&t&&cityssm.openHtmlModal("ticket-createSuccess",{onshow:function(){document.getElementById("createSuccess--ticketNumber").innerText=n,document.getElementById("createSuccess--editTicketButton").setAttribute("href","/tickets/"+e.ticketID+"/edit"),document.getElementById("createSuccess--newTicketButton").setAttribute("href","/tickets/new/"+e.nextTicketNumber)}})})}),t||document.getElementById("is-delete-ticket-button").addEventListener("click",function(t){t.preventDefault(),cityssm.confirmModal("Delete Ticket?","Are you sure you want to delete this ticket record?","Yes, Delete Ticket","danger",function(){cityssm.postJSON("/tickets/doDeleteTicket",{ticketID:e},function(e){e.success&&(window.location.href="/tickets")})})}),pts.getDefaultConfigProperty("locationClasses",function(e){for(var t,s={},a=[],n=0;n<e.length;n+=1){var i=e[n];s[i.locationClassKey]=i}var c=function(e){e.preventDefault();var s=a[parseInt(e.currentTarget.getAttribute("data-index"))];document.getElementById("ticket--locationKey").value=s.locationKey,document.getElementById("ticket--locationName").value=s.locationName,t(),a=[]},l=function(e){e.preventDefault(),cityssm.openHtmlModal("location-select",{onshown:function(e,n){t=n,cityssm.postJSON("/offences/doGetAllLocations",{},function(e){a=e;var t=document.createElement("div");t.className="list is-hoverable has-margin-bottom-20";for(var n=0;n<a.length;n+=1){var i=a[n],l=s[i.locationClassKey],o=document.createElement("a");o.className="list-item",o.setAttribute("data-index",n.toString()),o.setAttribute("href","#"),o.addEventListener("click",c),o.innerHTML='<div class="level"><div class="level-left">'+cityssm.escapeHTML(i.locationName)+"</div>"+(l?'<div class="level-right"><span class="tag is-primary">'+cityssm.escapeHTML(l.locationClass)+"</span></div>":"")+"</div>",t.insertAdjacentElement("beforeend",o)}var d=document.getElementById("container--parkingLocations");cityssm.clearElement(d),d.insertAdjacentElement("beforeend",t)})},onremoved:function(){document.getElementById("is-location-lookup-button").focus()}})};document.getElementById("is-location-lookup-button").addEventListener("click",l),document.getElementById("ticket--locationName").addEventListener("dblclick",l)});var c,l=[],o=function(e){e.preventDefault();var t=l[parseInt(e.currentTarget.getAttribute("data-index"))];document.getElementById("ticket--bylawNumber").value=t.bylawNumber;var s=document.getElementById("ticket--offenceAmount");s.classList.add("is-readonly"),s.setAttribute("readonly","readonly"),s.closest(".field").getElementsByClassName("is-unlock-field-button")[0].removeAttribute("disabled"),s.value=t.offenceAmount,document.getElementById("ticket--parkingOffence").value=t.bylawDescription,c(),l=[]},d=function(e){e.preventDefault(),cityssm.openHtmlModal("ticket-setBylawOffence",{onshown:function(e,t){var s;c=t,s=document.getElementById("ticket--locationKey").value,cityssm.postJSON("/offences/doGetOffencesByLocation",{locationKey:s},function(e){l=e;var t=document.createElement("div");t.className="list is-hoverable has-margin-bottom-20";for(var s=0;s<l.length;s+=1){var a=l[s],n=document.createElement("a");n.className="list-item",n.setAttribute("data-index",s.toString()),n.setAttribute("href","#"),n.addEventListener("click",o),n.innerHTML='<div class="columns"><div class="column">'+cityssm.escapeHTML(a.bylawNumber)+"<br /><small>"+cityssm.escapeHTML(a.bylawDescription)+'</small></div><div class="column is-narrow">$ '+a.offenceAmount.toFixed(2)+"</div></div>",t.insertAdjacentElement("beforeend",n)}var i=document.getElementById("container--bylawNumbers");cityssm.clearElement(i),i.appendChild(t)}),document.getElementById("bylawLookup--searchStr").focus()},onremoved:function(){document.getElementById("is-bylaw-lookup-button").focus()}})};document.getElementById("is-bylaw-lookup-button").addEventListener("click",d),document.getElementById("ticket--bylawNumber").addEventListener("dblclick",d);var r=function(){var e=document.getElementById("datalist--licencePlateProvince");cityssm.clearElement(e);var t=pts.getLicencePlateCountryProperties(document.getElementById("ticket--licencePlateCountry").value);if(t&&t.provinces)for(var s=Object.values(t.provinces),a=0;a<s.length;a+=1){var n=document.createElement("option");n.setAttribute("value",s[a].provinceShortName),e.appendChild(n)}};document.getElementById("ticket--licencePlateCountry").addEventListener("change",r),pts.loadDefaultConfigProperties(r);var u=function(e){for(var t=e.getElementsByClassName("panel-block");t.length>0;)t[0].remove()};if(!t){var m=document.getElementById("is-remark-panel"),v=exports.ticketRemarks;delete exports.ticketRemarks;var f=function(t){var s=t.currentTarget.getAttribute("data-remark-index");cityssm.confirmModal("Delete Remark?","Are you sure you want to delete this remark?","Yes, Delete","warning",function(){cityssm.postJSON("/tickets/doDeleteRemark",{ticketID:e,remarkIndex:s},function(e){e.success&&k()})})},g=function(t){var s;t.preventDefault();var a=parseInt(t.currentTarget.getAttribute("data-index")),n=v[a],i=function(e){e.preventDefault(),cityssm.postJSON("/tickets/doUpdateRemark",e.currentTarget,function(e){e.success&&(s(),k())})};cityssm.openHtmlModal("ticket-editRemark",{onshow:function(t){document.getElementById("editRemark--ticketID").value=e,document.getElementById("editRemark--remarkIndex").value=n.remarkIndex,document.getElementById("editRemark--remark").value=n.remark,document.getElementById("editRemark--remarkDateString").value=n.remarkDateString,document.getElementById("editRemark--remarkTimeString").value=n.remarkTimeString,t.getElementsByTagName("form")[0].addEventListener("submit",i)},onshown:function(e,t){s=t}})},p=function(){if(u(m),0!==v.length)for(var e=0;e<v.length;e+=1){var t=v[e],s=document.createElement("div");s.className="panel-block is-block",s.innerHTML='<div class="columns"><div class="column"><p class="has-newline-chars">'+cityssm.escapeHTML(t.remark)+'</p><p class="is-size-7">'+(t.recordCreate_timeMillis===t.recordUpdate_timeMillis?"":'<i class="fas fa-pencil-alt" aria-hidden="true"></i> ')+t.recordUpdate_userName+" - "+t.remarkDateString+" "+t.remarkTimeString+"</p></div>"+(t.canUpdate?'<div class="column is-narrow"><div class="buttons is-right has-addons"><button class="button is-small is-edit-remark-button" data-tooltip="Edit Remark" data-index="'+e+'" type="button"><span class="icon is-small"><i class="fas fa-pencil-alt" aria-hidden="true"></i></span> <span>Edit</span></button><button class="button is-small has-text-danger is-delete-remark-button" data-tooltip="Delete Remark" data-remark-index="'+t.remarkIndex+'" type="button"><i class="fas fa-trash" aria-hidden="true"></i><span class="sr-only">Delete</span></button></div></div>':"")+"</div>",t.canUpdate&&(s.getElementsByClassName("is-edit-remark-button")[0].addEventListener("click",g),s.getElementsByClassName("is-delete-remark-button")[0].addEventListener("click",f)),m.appendChild(s)}else m.insertAdjacentHTML("beforeend",'<div class="panel-block is-block"><div class="message is-info"><p class="message-body">There are no remarks associated with this ticket.</p></div></div>')},k=function(){u(m),m.insertAdjacentHTML("beforeend",'<div class="panel-block is-block"><p class="has-text-centered has-text-grey-lighter"><i class="fas fa-2x fa-circle-notch fa-spin" aria-hidden="true"></i><br /><em>Loading remarks...</p></div>'),cityssm.postJSON("/tickets/doGetRemarks",{ticketID:e},function(e){v=e,p()})};document.getElementById("is-add-remark-button").addEventListener("click",function(t){var s;t.preventDefault();var a=function(e){e.preventDefault(),cityssm.postJSON("/tickets/doAddRemark",e.currentTarget,function(e){e.success&&(s(),k())})};cityssm.openHtmlModal("ticket-addRemark",{onshow:function(t){document.getElementById("addRemark--ticketID").value=e,t.getElementsByTagName("form")[0].addEventListener("submit",a)},onshown:function(e,t){s=t}})}),p()}if(!t){var y=document.getElementById("is-status-panel"),b=exports.ticketStatusLog;delete exports.ticketStatusLog;var h=function(t){t.preventDefault(),cityssm.confirmModal("Mark Ticket as Resolved?","Once resolved, you will no longer be able to make changes to the ticket.","Yes, Resolve Ticket","info",function(){cityssm.postJSON("/tickets/doResolveTicket",{ticketID:e},function(t){t.success&&(window.location.href="/tickets/"+e)})})},E=function(t){var s=t.currentTarget.getAttribute("data-status-index");cityssm.confirmModal("Delete Remark?","Are you sure you want to delete this status?","Yes, Delete","warning",function(){cityssm.postJSON("/tickets/doDeleteStatus",{ticketID:e,statusIndex:s},function(e){e.success&&B()})})},T=function(t){var s;t.preventDefault();var a=parseInt(t.currentTarget.getAttribute("data-index")),n=b[a],i=function(e){e.preventDefault(),cityssm.postJSON("/tickets/doUpdateStatus",e.currentTarget,function(e){e.success&&(s(),B())})},c=function(e){var t=pts.getTicketStatus(e.currentTarget.value),s=document.getElementById("editStatus--statusField");if(s.value="",t&&t.statusField){var a=s.closest(".field");a.getElementsByTagName("label")[0].innerText=t.statusField.fieldLabel,a.classList.remove("is-hidden")}else s.closest(".field").classList.add("is-hidden")};cityssm.openHtmlModal("ticket-editStatus",{onshow:function(t){document.getElementById("editStatus--ticketID").value=e,document.getElementById("editStatus--statusIndex").value=n.statusIndex,document.getElementById("editStatus--statusField").value=n.statusField,document.getElementById("editStatus--statusNote").value=n.statusNote;var s=document.getElementById("editStatus--statusDateString");s.value=n.statusDateString,s.setAttribute("max",cityssm.dateToString(new Date)),document.getElementById("editStatus--statusTimeString").value=n.statusTimeString,pts.getDefaultConfigProperty("parkingTicketStatuses",function(e){for(var t=!1,s=document.getElementById("editStatus--statusKey"),a=0;a<e.length;a+=1){var i=e[a];if((i.isUserSettable||i.statusKey===n.statusKey)&&(s.insertAdjacentHTML("beforeend",'<option value="'+i.statusKey+'">'+i.status+"</option>"),i.statusKey===n.statusKey&&(t=!0,i.statusField))){var l=document.getElementById("editStatus--statusField").closest(".field");l.getElementsByTagName("label")[0].innerText=i.statusField.fieldLabel,l.classList.remove("is-hidden")}}t||s.insertAdjacentHTML("beforeend",'<option value="'+n.statusKey+'">'+n.statusKey+"</option>"),s.value=n.statusKey,s.addEventListener("change",c)}),t.getElementsByTagName("form")[0].addEventListener("submit",i)},onshown:function(e,t){s=t}})},I=function(){if(u(y),0!==b.length)for(var e=0;e<b.length;e+=1){var t=b[e],s=pts.getTicketStatus(t.statusKey);if(0===e&&s&&s.isFinalStatus){var a=document.createElement("div");a.className="panel-block is-block",a.innerHTML='<div class="message is-info is-clearfix"><div class="message-body"><div class="columns"><div class="column"><strong>This ticket is able to be marked as resolved.</strong></div><div class="column is-narrow has-text-right"><button class="button is-info" type="button"><span class="icon is-small"><i class="fas fa-check" aria-hidden="true"></i></span><span>Resolve Ticket</span></button></div></div></div></div>',a.getElementsByTagName("button")[0].addEventListener("click",h),y.appendChild(a)}var n=document.createElement("div");n.className="panel-block is-block",n.innerHTML='<div class="columns"><div class="column"><div class="level has-margin-bottom-5"><div class="level-left"><strong>'+(s?s.status:t.statusKey)+'</strong></div><div class="level-right">'+t.statusDateString+"</div></div>"+(""===t.statusField?"":'<p class="is-size-7"><strong>'+(s&&s.statusField?s.statusField.fieldLabel:"")+":</strong> "+t.statusField+"</p>")+'<p class="has-newline-chars is-size-7">'+t.statusNote+"</p></div>"+(t.canUpdate&&0===e?'<div class="column is-narrow"><div class="buttons is-right has-addons"><button class="button is-small is-edit-status-button" data-tooltip="Edit Status" data-index="'+e+'" type="button"><span class="icon is-small"><i class="fas fa-pencil-alt" aria-hidden="true"></i></span> <span>Edit</span></button><button class="button is-small has-text-danger is-delete-status-button" data-tooltip="Delete Status" data-status-index="'+t.statusIndex+'" type="button"><i class="fas fa-trash" aria-hidden="true"></i><span class="sr-only">Delete</span></button></div></div>':"")+"</div>",t.canUpdate&&0===e&&(n.getElementsByClassName("is-edit-status-button")[0].addEventListener("click",T),n.getElementsByClassName("is-delete-status-button")[0].addEventListener("click",E)),y.appendChild(n)}else y.insertAdjacentHTML("beforeend",'<div class="panel-block is-block"><div class="message is-info"><p class="message-body">There are no statuses associated with this ticket.</p></div></div>')},B=function(){u(y),y.insertAdjacentHTML("beforeend",'<div class="panel-block is-block"><p class="has-text-centered has-text-grey-lighter"><i class="fas fa-2x fa-circle-notch fa-spin" aria-hidden="true"></i><br /><em>Loading statuses...</p></div>'),cityssm.postJSON("/tickets/doGetStatuses",{ticketID:e},function(e){b=e,I()})};document.getElementById("is-add-status-button").addEventListener("click",function(t){var s;t.preventDefault();var a=function(t){t.preventDefault();var a=document.getElementById("addStatus--resolveTicket").checked;cityssm.postJSON("/tickets/doAddStatus",t.currentTarget,function(t){t.success&&(s(),a?window.location.href="/tickets/"+e:B())})},n=function(e){var t=pts.getTicketStatus(e.currentTarget.value),s=document.getElementById("addStatus--statusField");if(s.value="",t&&t.statusField){var a=s.closest(".field");a.getElementsByTagName("label")[0].innerText=t.statusField.fieldLabel,a.classList.remove("is-hidden")}else s.closest(".field").classList.add("is-hidden");var n=document.getElementById("addStatus--resolveTicket");n.checked=!1,t&&t.isFinalStatus?n.closest(".field").classList.remove("is-hidden"):n.closest(".field").classList.add("is-hidden")};cityssm.openHtmlModal("ticket-addStatus",{onshow:function(t){document.getElementById("addStatus--ticketID").value=e,pts.getDefaultConfigProperty("parkingTicketStatuses",function(e){for(var t=document.getElementById("addStatus--statusKey"),s=0;s<e.length;s+=1){var a=e[s];a.isUserSettable&&t.insertAdjacentHTML("beforeend",'<option value="'+a.statusKey+'">'+a.status+"</option>")}t.addEventListener("change",n)}),t.getElementsByTagName("form")[0].addEventListener("submit",a)},onshown:function(e,t){s=t}})}),pts.loadDefaultConfigProperties(I)}for(var S=function(e){e.preventDefault();var t=e.currentTarget,s=t.getAttribute("data-unlock"),a=t.closest(".field").getElementsByTagName(s)[0];a.removeAttribute("readonly"),a.classList.remove("is-readonly"),a.focus(),t.setAttribute("disabled","disabled")},L=document.getElementsByClassName("is-unlock-field-button"),N=0;N<L.length;N+=1)L[N].addEventListener("click",S)}();