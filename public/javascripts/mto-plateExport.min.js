"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),(()=>{var e;const t="true"===(null===(e=document.querySelector("main"))||void 0===e?void 0:e.dataset.canUpdate);let a=-1,s=!0,n=!1,c=!1;const i=document.querySelector("#available--issueDaysAgo"),l=document.querySelector("#is-available-tickets-container"),o=document.querySelector("#available--licencePlateNumber");let r=[],d=[];function p(e){var t;e.preventDefault();const s=e.currentTarget;s.setAttribute("disabled","disabled");const n=Number.parseInt(null!==(t=s.dataset.index)&&void 0!==t?t:"-1",10),c=r[n],i=s.closest(".is-ticket-container");cityssm.postJSON("/plates/doAddLicencePlateToLookupBatch",{batchID:a,licencePlateCountry:"CA",licencePlateProvince:"ON",licencePlateNumber:c.licencePlateNumber,ticketID:c.ticketID},e=>{e.success?(i.remove(),r[n]=void 0,k(e.batch)):s.removeAttribute("disabled")})}function u(e){e.preventDefault();const t=e.currentTarget;t.setAttribute("disabled","disabled");const s=Number.parseInt(t.dataset.index,10),n=d[s],c=t.closest(".is-entry-container");cityssm.postJSON("/plates/doRemoveLicencePlateFromLookupBatch",{batchID:a,ticketID:n.ticketID,licencePlateCountry:"CA",licencePlateProvince:"ON",licencePlateNumber:n.licencePlateNumber},e=>{e.success?(c.remove(),v()):t.removeAttribute("disabled")})}function m(e){e.preventDefault();cityssm.confirmModal("Clear Batch?","Are you sure you want to remove all licence plates from the batch?","Yes, Clear the Batch","warning",()=>{cityssm.postJSON("/plates/doClearLookupBatch",{batchID:a},e=>{e.success&&(k(e.batch),v())})})}const b=e=>{e.preventDefault();const t=()=>{window.open("/plates-ontario/mtoExport/"+a.toString()),c=!0};c?t():cityssm.confirmModal("Download Batch?","<strong>You are about to download this batch for the first time.</strong><br />The date of this download will be tracked as part of the batch record.","OK, Download the File","warning",t)},h=()=>{cityssm.clearElement(l);const e=document.createElement("div");e.className="panel";const t=o.value.toLowerCase().trim().split(" "),s=[];for(const[a,n]of r.entries()){if(!n)continue;let c=!0;const i=n.licencePlateNumber.toLowerCase();for(const e of t)if(!i.includes(e)){c=!1;break}if(!c)continue;s.push(n.ticketID);const l=document.createElement("div");l.className="panel-block is-block is-ticket-container",l.innerHTML='<div class="level is-marginless"><div class="level-left"><div class="licence-plate"><div class="licence-plate-number">'+cityssm.escapeHTML(n.licencePlateNumber)+'</div></div></div><div class="level-right"><button class="button is-small" data-index="'+a.toString()+'" data-cy="add-ticket" data-tooltip="Add to Batch" type="button"><span class="icon is-small"><i class="fas fa-plus" aria-hidden="true"></i></span><span>Add</span></button></div></div><div class="level"><div class="level-left"><div class="tags"><a class="tag has-tooltip-bottom" data-tooltip="View Ticket (Opens in New Window)" href="/tickets/'+encodeURIComponent(n.ticketID)+'" target="_blank">'+cityssm.escapeHTML(n.ticketNumber)+'</a></div></div><div class="level-right is-size-7">'+n.issueDateString+"</div></div>",l.querySelector("button").addEventListener("click",p),e.append(l)}if(s.length>0){const t=document.createElement("button");t.className="button is-fullwidth mb-3",t.dataset.cy="add-tickets",t.innerHTML='<span class="icon is-small"><i class="fas fa-plus" aria-hidden="true"></i></span><span>Add '+s.length.toString()+" Parking Ticket"+(1===s.length?"":"s")+"</span>",t.addEventListener("click",()=>{cityssm.openHtmlModal("loading",{onshown(e,t){document.querySelector("#is-loading-modal-message").textContent="Adding "+s.length.toString()+" Parking Ticket"+(1===s.length?"":"s")+"...",cityssm.postJSON("/plates/doAddAllParkingTicketsToLookupBatch",{batchID:a,ticketIDs:s},e=>{t(),e.success&&(k(e.batch),v())})}})}),l.append(t),l.append(e)}else l.innerHTML='<div class="message is-info"><div class="message-body">There are no parking tickets that meet your search criteria.</div></div>'},v=()=>{s?l.innerHTML='<div class="message is-info"><div class="message-body">Parking Tickets cannot be added to a locked batch.</div></div>':(l.innerHTML='<p class="has-text-centered has-text-grey-lighter"><i class="fas fa-3x fa-circle-notch fa-spin" aria-hidden="true"></i><br /><em>Loading parking tickets...</p>',cityssm.postJSON("/plates-ontario/doGetParkingTicketsAvailableForMTOLookup",{batchID:a,issueDaysAgo:i.value},e=>{r=e.tickets,h()}))};document.querySelector("#is-more-available-filters-toggle").addEventListener("click",e=>{e.preventDefault(),document.querySelector("#is-more-available-filters").classList.toggle("is-hidden")}),o.addEventListener("keyup",h),i.addEventListener("change",v);const f=document.querySelector("#is-lock-batch-button"),g=document.querySelector("#is-batch-entries-container"),k=e=>{if(a=e.batchID,d=e.batchEntries,s=""!==e.lockDateString,c=""!==e.sentDateString,n=e.mto_includeLabels,t&&(s?f.setAttribute("disabled","disabled"):f.removeAttribute("disabled")),document.querySelector("#batchSelector--batchID").innerHTML="Batch #"+e.batchID.toString()+"<br />"+(n?'<span class="tag is-light"><span class="icon is-small"><i class="fas fa-tag" aria-hidden="true"></i></span> <span>Include Labels</span></span>':"")+" "+(s?'<span class="tag is-light"><span class="icon is-small"><i class="fas fa-lock" aria-hidden="true"></i></span> <span>'+e.lockDateString+"</span></span>":""),document.querySelector("#batchSelector--batchDetails").innerHTML='<span class="icon is-small"><i class="fas fa-calendar" aria-hidden="true"></i></span><span>'+e.batchDateString+"</span>",cityssm.clearElement(g),0===d.length)return void(g.innerHTML='<div class="message is-info"><p class="message-body">There are no parking tickets included in the batch.</p></div>');cityssm.clearElement(g);const i=document.createElement("div");i.className="panel";for(const[e,t]of d.entries()){const a=document.createElement("div");a.className="panel-block is-block is-entry-container",a.innerHTML='<div class="level mb-0"><div class="level-left"><div class="licence-plate"><div class="licence-plate-number">'+cityssm.escapeHTML(t.licencePlateNumber)+"</div></div></div>"+(s?"":'<div class="level-right"><button class="button is-small" data-index="'+e.toString()+'" data-cy="remove-ticket" type="button"><span class="icon is-small"><i class="fas fa-minus" aria-hidden="true"></i></span><span>Remove</span></button></div>')+'</div><a class="tag has-tooltip-bottom" data-tooltip="View Ticket (Opens in New Window)" href="/tickets/'+encodeURIComponent(t.ticketID)+'" target="_blank">'+cityssm.escapeHTML(t.ticketNumber)+"</a>",s||a.querySelector("button").addEventListener("click",u),i.append(a)}if(s){const e=document.createElement("button");e.className="button is-fullwidth mb-3",e.innerHTML='<span class="icon is-small"><i class="fas fa-download" aria-hidden="true"></i></span><span>Download File for MTO</span>',e.addEventListener("click",b),g.append(e),g.insertAdjacentHTML("beforeend",'<a class="button is-fullwidth mb-3" href="https://www.aris.mto.gov.on.ca/edtW/login/login.jsp" target="_blank" rel="noreferrer"><span class="icon is-small"><i class="fas fa-building" aria-hidden="true"></i></span><span>MTO ARIS Login</span></a>')}else{const e=document.createElement("button");e.className="button is-fullwidth mb-3",e.dataset.cy="clear-batch",e.innerHTML='<span class="icon is-small"><i class="fas fa-broom" aria-hidden="true"></i></span><span>Clear Batch</span>',e.addEventListener("click",m),g.append(e)}g.append(i)};document.querySelector("#is-select-batch-button").addEventListener("click",e=>{let s,n;e.preventDefault();const c=e=>{e.preventDefault(),a=Number.parseInt(e.currentTarget.dataset.batchId,10),s(),cityssm.postJSON("/plates/doGetLookupBatch",{batchID:a},e=>{k(e),v()})};cityssm.openHtmlModal("mto-selectBatch",{onshow(e){if(n=e.querySelector(".is-results-container"),cityssm.postJSON("/plates/doGetUnreceivedLicencePlateLookupBatches",{},e=>{if(0===e.length)return void(n.innerHTML='<div class="message is-info"><p class="message-body">There are no unsent batches available.</p></div>');const t=document.createElement("div");t.className="panel";for(const a of e){const e=document.createElement("a");e.className="panel-block is-block",e.setAttribute("href","#"),e.dataset.batchId=a.batchID.toString(),e.innerHTML='<div class="columns"><div class="column is-narrow">#'+a.batchID.toString()+'</div><div class="column has-text-right">'+a.batchDateString+'<br /><div class="tags justify-flex-end">'+(a.mto_includeLabels?'<span class="tag"><span class="icon is-small"><i class="fas fa-tag" aria-hidden="true"></i></span><span>Includes Labels</span></span>':"")+(a.lockDate?'<span class="tag"><span class="icon is-small"><i class="fas fa-lock" aria-hidden="true"></i></span><span>Locked</span></span>':"")+(a.sentDate?'<span class="tag"><span class="icon is-small"><i class="fas fa-share" aria-hidden="true"></i></span><span>Sent to MTO</span></span>':"")+"</div></div></div>",e.addEventListener("click",c),t.append(e)}cityssm.clearElement(n),n.append(t)}),t){const t=e.querySelector(".is-create-batch-button");t.classList.remove("is-hidden"),t.addEventListener("click",()=>{s(),(()=>{let e;const t=t=>{t.preventDefault();const a=t.currentTarget.dataset.includeLabels;cityssm.postJSON("/plates/doCreateLookupBatch",{mto_includeLabels:a},t=>{t.success&&(e(),k(t.batch),v())})};cityssm.openHtmlModal("mto-createBatch",{onshow:e=>{const a=e.querySelectorAll(".is-create-batch-button");for(const e of a)e.addEventListener("click",t)},onshown:(t,a)=>{e=a}})})()})}},onshown(e,t){s=t}})}),t&&f.addEventListener("click",()=>{if(s)return;cityssm.confirmModal("Lock Batch?",'<strong>Are you sure you want to lock the batch?</strong><br />Once the batch is locked, no licence plates can be added or deleted from the batch. All tickets related to the licence plates in the batch will be updated with a "Pending Lookup" status.',"Yes, Lock the Batch","info",()=>{cityssm.postJSON("/plates/doLockLookupBatch",{batchID:a},e=>{e.success&&k(e.batch)})})}),exports.plateExportBatch&&(k(exports.plateExportBatch),delete exports.plateExportBatch,v())})();