"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),(()=>{const e="true"===document.querySelector("main").dataset.canUpdate;let t=-1,a=!0,s=!1;const c=document.querySelector("#available--issueDaysAgo"),n=document.querySelector("#is-available-tickets-container"),i=document.querySelector("#available--licencePlateNumber");let l=[],o=[];const r=e=>{e.preventDefault();const a=e.currentTarget;a.setAttribute("disabled","disabled");const s=Number.parseInt(a.dataset.index,10),c=l[s],n=a.closest(".is-ticket-container");cityssm.postJSON("/plates/doAddLicencePlateToLookupBatch",{batchID:t,licencePlateCountry:"CA",licencePlateProvince:"ON",licencePlateNumber:c.licencePlateNumber,ticketID:c.ticketID},e=>{e.success?(n.remove(),l[s]=void 0,f(e.batch)):a.removeAttribute("disabled")})},d=e=>{e.preventDefault();const a=e.currentTarget;a.setAttribute("disabled","disabled");const s=Number.parseInt(a.dataset.index,10),c=o[s],n=a.closest(".is-entry-container");cityssm.postJSON("/plates/doRemoveLicencePlateFromLookupBatch",{batchID:t,ticketID:c.ticketID,licencePlateCountry:"CA",licencePlateProvince:"ON",licencePlateNumber:c.licencePlateNumber},e=>{e.success?(n.remove(),b()):a.removeAttribute("disabled")})},p=e=>{e.preventDefault();cityssm.confirmModal("Clear Batch?","Are you sure you want to remove all licence plates from the batch?","Yes, Clear the Batch","warning",()=>{cityssm.postJSON("/plates/doClearLookupBatch",{batchID:t},e=>{e.success&&(f(e.batch),b())})})},u=e=>{e.preventDefault();const a=()=>{window.open("/plates-ontario/mtoExport/"+t.toString()),s=!0};s?a():cityssm.confirmModal("Download Batch?","<strong>You are about to download this batch for the first time.</strong><br />The date of this download will be tracked as part of the batch record.","OK, Download the File","warning",a)},m=()=>{cityssm.clearElement(n);const e=document.createElement("div");e.className="panel";const a=i.value.toLowerCase().trim().split(" "),s=[];for(const[t,c]of l.entries()){if(!c)continue;let n=!0;const i=c.licencePlateNumber.toLowerCase();for(const e of a)if(!i.includes(e)){n=!1;break}if(!n)continue;s.push(c.ticketID);const l=document.createElement("div");l.className="panel-block is-block is-ticket-container",l.innerHTML='<div class="level is-marginless"><div class="level-left"><div class="licence-plate"><div class="licence-plate-number">'+cityssm.escapeHTML(c.licencePlateNumber)+'</div></div></div><div class="level-right"><button class="button is-small" data-index="'+t.toString()+'" data-cy="add-ticket" data-tooltip="Add to Batch" type="button"><span class="icon is-small"><i class="fas fa-plus" aria-hidden="true"></i></span><span>Add</span></button></div></div><div class="level"><div class="level-left"><div class="tags"><a class="tag has-tooltip-bottom" data-tooltip="View Ticket (Opens in New Window)" href="/tickets/'+encodeURIComponent(c.ticketID)+'" target="_blank">'+cityssm.escapeHTML(c.ticketNumber)+'</a></div></div><div class="level-right is-size-7">'+c.issueDateString+"</div></div>",l.querySelector("button").addEventListener("click",r),e.append(l)}if(s.length>0){const a=document.createElement("button");a.className="button is-fullwidth mb-3",a.dataset.cy="add-tickets",a.innerHTML='<span class="icon is-small"><i class="fas fa-plus" aria-hidden="true"></i></span><span>Add '+s.length.toString()+" Parking Ticket"+(1===s.length?"":"s")+"</span>",a.addEventListener("click",()=>{cityssm.openHtmlModal("loading",{onshown(e,a){document.querySelector("#is-loading-modal-message").textContent="Adding "+s.length.toString()+" Parking Ticket"+(1===s.length?"":"s")+"...",cityssm.postJSON("/plates/doAddAllParkingTicketsToLookupBatch",{batchID:t,ticketIDs:s},e=>{a(),e.success&&(f(e.batch),b())})}})}),n.append(a),n.append(e)}else n.innerHTML='<div class="message is-info"><div class="message-body">There are no parking tickets that meet your search criteria.</div></div>'},b=()=>{a?n.innerHTML='<div class="message is-info"><div class="message-body">Parking Tickets cannot be added to a locked batch.</div></div>':(n.innerHTML='<p class="has-text-centered has-text-grey-lighter"><i class="fas fa-3x fa-circle-notch fa-spin" aria-hidden="true"></i><br /><em>Loading parking tickets...</p>',cityssm.postJSON("/plates-ontario/doGetParkingTicketsAvailableForMTOLookup",{batchID:t,issueDaysAgo:c.value},e=>{l=e.tickets,m()}))};document.querySelector("#is-more-available-filters-toggle").addEventListener("click",e=>{e.preventDefault(),document.querySelector("#is-more-available-filters").classList.toggle("is-hidden")}),i.addEventListener("keyup",m),c.addEventListener("change",b);const h=document.querySelector("#is-lock-batch-button"),v=document.querySelector("#is-batch-entries-container"),f=c=>{if(t=c.batchID,o=c.batchEntries,a=""!==c.lockDateString,s=""!==c.sentDateString,e&&(a?h.setAttribute("disabled","disabled"):h.removeAttribute("disabled")),document.querySelector("#batchSelector--batchID").textContent="Batch #"+c.batchID.toString(),document.querySelector("#batchSelector--batchDetails").innerHTML='<span class="icon is-small"><i class="fas fa-calendar" aria-hidden="true"></i></span><span>'+c.batchDateString+"</span> "+(a?'<span class="tag is-light"><span class="icon is-small"><i class="fas fa-lock" aria-hidden="true"></i></span> <span>'+c.lockDateString+"</span></span>":""),cityssm.clearElement(v),0===o.length)return void(v.innerHTML='<div class="message is-info"><p class="message-body">There are no parking tickets included in the batch.</p></div>');cityssm.clearElement(v);const n=document.createElement("div");n.className="panel";for(const[e,t]of o.entries()){const s=document.createElement("div");s.className="panel-block is-block is-entry-container",s.innerHTML='<div class="level mb-0"><div class="level-left"><div class="licence-plate"><div class="licence-plate-number">'+cityssm.escapeHTML(t.licencePlateNumber)+"</div></div></div>"+(a?"":'<div class="level-right"><button class="button is-small" data-index="'+e.toString()+'" data-cy="remove-ticket" type="button"><span class="icon is-small"><i class="fas fa-minus" aria-hidden="true"></i></span><span>Remove</span></button></div>')+'</div><a class="tag has-tooltip-bottom" data-tooltip="View Ticket (Opens in New Window)" href="/tickets/'+encodeURIComponent(t.ticketID)+'" target="_blank">'+cityssm.escapeHTML(t.ticketNumber)+"</a>",a||s.querySelector("button").addEventListener("click",d),n.append(s)}if(a){const e=document.createElement("button");e.className="button is-fullwidth mb-3",e.innerHTML='<span class="icon is-small"><i class="fas fa-download" aria-hidden="true"></i></span><span>Download File for MTO</span>',e.addEventListener("click",u),v.append(e),v.insertAdjacentHTML("beforeend",'<a class="button is-fullwidth mb-3" href="https://www.apps.rus.mto.gov.on.ca/edtW/login/login.jsp" target="_blank" rel="noreferrer"><span class="icon is-small"><i class="fas fa-building" aria-hidden="true"></i></span><span>MTO ARIS Login</span></a>')}else{const e=document.createElement("button");e.className="button is-fullwidth mb-3",e.dataset.cy="clear-batch",e.innerHTML='<span class="icon is-small"><i class="fas fa-broom" aria-hidden="true"></i></span><span>Clear Batch</span>',e.addEventListener("click",p),v.append(e)}v.append(n)};document.querySelector("#is-select-batch-button").addEventListener("click",a=>{let s,c;a.preventDefault();const n=e=>{e.preventDefault(),t=Number.parseInt(e.currentTarget.dataset.batchId,10),s(),cityssm.postJSON("/plates/doGetLookupBatch",{batchID:t},e=>{f(e),b()})};cityssm.openHtmlModal("mto-selectBatch",{onshow(t){if(c=t.querySelector(".is-results-container"),cityssm.postJSON("/plates/doGetUnreceivedLicencePlateLookupBatches",{},e=>{if(0===e.length)return void(c.innerHTML='<div class="message is-info"><p class="message-body">There are no unsent batches available.</p></div>');const t=document.createElement("div");t.className="panel";for(const a of e){const e=document.createElement("a");e.className="panel-block is-block",e.setAttribute("href","#"),e.dataset.batchId=a.batchID.toString(),e.innerHTML='<div class="columns"><div class="column is-narrow">#'+a.batchID.toString()+'</div><div class="column has-text-right">'+a.batchDateString+'<br /><div class="tags justify-flex-end">'+(a.lockDate?'<span class="tag"><span class="icon is-small"><i class="fas fa-lock" aria-hidden="true"></i></span><span>Locked</span></span>':"")+(a.sentDate?'<span class="tag"><span class="icon is-small"><i class="fas fa-share" aria-hidden="true"></i></span><span>Sent to MTO</span></span>':"")+"</div></div></div>",e.addEventListener("click",n),t.append(e)}cityssm.clearElement(c),c.append(t)}),e){const e=t.querySelector(".is-create-batch-button");e.classList.remove("is-hidden"),e.addEventListener("click",()=>{s(),(()=>{let e;const t=t=>{t.preventDefault();const a=t.currentTarget.dataset.includeLabels;cityssm.postJSON("/plates/doCreateLookupBatch",{mto_includeLabels:a},t=>{t.success&&(e(),f(t.batch),b())})};cityssm.openHtmlModal("mto-createBatch",{onshow:e=>{const a=e.querySelectorAll(".is-create-batch-button");for(const e of a)e.addEventListener("click",t)},onshown:(t,a)=>{e=a}})})()})}},onshown(e,t){s=t}})}),e&&h.addEventListener("click",()=>{if(a)return;cityssm.confirmModal("Lock Batch?",'<strong>Are you sure you want to lock the batch?</strong><br />Once the batch is locked, no licence plates can be added or deleted from the batch. All tickets related to the licence plates in the batch will be updated with a "Pending Lookup" status.',"Yes, Lock the Batch","info",()=>{cityssm.postJSON("/plates/doLockLookupBatch",{batchID:t},e=>{e.success&&f(e.batch)})})}),exports.plateExportBatch&&(f(exports.plateExportBatch),delete exports.plateExportBatch,b())})();