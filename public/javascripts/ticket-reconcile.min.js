(function(){function n(b){b.preventDefault();var f=b.currentTarget;f.setAttribute("disabled","disabled");b=f.getAttribute("data-batch-id");var d=f.getAttribute("data-log-index");cityssm.postJSON("/tickets/doAcknowledgeLookupError",{batchID:b,logIndex:d},function(a){a.success?(a=f.closest("td"),cityssm.clearElement(a),a.innerHTML='<span class="tag is-light is-warning"><span class="icon is-small"><i class="fas fa-check" aria-hidden="true"></i></span><span>Acknowledged</span></span>'):f.removeAttribute("disabled")})}
function k(b){b.preventDefault();var f=b.currentTarget,d=f.closest("td"),a=d.closest("tr");pts.confirmModal("Clear Status","Are you sure you want to undo this status?","Yes, Remove the Status","warning",function(){cityssm.postJSON("/tickets/doDeleteStatus",{ticketID:a.getAttribute("data-ticket-id"),statusIndex:f.getAttribute("data-status-index")},function(a){a.success&&(cityssm.clearElement(d),d.classList.remove("has-width-200"),d.innerHTML='<button class="button is-success is-ownership-match-button" type="button"><span class="icon"><i class="fas fa-check" aria-hidden="true"></i></span><span>Match</span></button> <button class="button is-danger is-ownership-error-button" type="button"><i class="fas fa-times" aria-hidden="true"></i><span class="sr-only">Error</span></button>',
d.getElementsByClassName("is-ownership-match-button")[0].addEventListener("click",g),d.getElementsByClassName("is-ownership-error-button")[0].addEventListener("click",m))})})}pts.initializeToggleHiddenLinks(document.getElementsByTagName("main")[0]);for(var c=document.getElementsByClassName("is-acknowledge-error-button"),e=0;e<c.length;e+=1)c[e].addEventListener("click",n);var g,m;g=function(b){b.preventDefault();var f=b.currentTarget,d=f.closest("td"),a=d.closest("tr");b=function(){f.setAttribute("disabled",
"disabled");var b=a.getAttribute("data-licence-plate-country"),c=a.getAttribute("data-licence-plate-province"),e=a.getAttribute("data-licence-plate-number"),h=a.getAttribute("data-ticket-id"),l=a.getAttribute("data-record-date");cityssm.postJSON("/tickets/doReconcileAsMatch",{licencePlateCountry:b,licencePlateProvince:c,licencePlateNumber:e,ticketID:h,recordDate:l},function(a){a.success?(cityssm.clearElement(d),d.innerHTML='<div class="tags has-addons"><span class="tag is-light is-success"><span class="icon is-small"><i class="fas fa-check" aria-hidden="true"></i></span><span>Match</span></span><a class="tag" data-tooltip="Remove Match" data-status-index="'+
a.statusIndex+'" data-tooltip="Remove Match" href="#"><i class="far fa-trash-alt" aria-hidden="true"></i><span class="sr-only">Remove Match</span></a></div>',d.getElementsByTagName("a")[0].addEventListener("click",k)):(f.removeAttribute("disabled"),pts.alertModal("Record Not Updated",a.message,"OK","danger"))})};if(a.hasAttribute("data-is-vehicle-make-match")&&a.hasAttribute("data-is-licence-plate-expiry-date-match"))b();else{var e=a.getAttribute("data-ticket-vehicle"),c=a.getAttribute("data-ticket-expiry-date"),
h=a.getAttribute("data-owner-vehicle"),g=a.getAttribute("data-owner-expiry-date");pts.confirmModal("Confirm Match",'<p class="has-text-centered">Are you sure the details on the parking ticket match the details on the ownership record?</p><div class="columns has-margin-top-5">'+('<div class="column has-text-centered"><strong>Parking Ticket</strong><br /><span class="is-size-4">'+cityssm.escapeHTML(e)+'</span><br /><span class="is-size-5">'+(""===c?"(Not Set)":cityssm.escapeHTML(c))+"</span></div>")+
('<div class="column has-text-centered"><strong>Ownership Record</strong><br /><span class="is-size-4">'+cityssm.escapeHTML(h)+'</span><br /><span class="is-size-5">'+cityssm.escapeHTML(g)+"</span></div>")+"</div>","Yes, Confirm Match","warning",b)}};m=function(b){b.preventDefault();var f=b.currentTarget,d=f.closest("td"),a=d.closest("tr");b=function(){f.setAttribute("disabled","disabled");var b=a.getAttribute("data-licence-plate-country"),e=a.getAttribute("data-licence-plate-province"),c=a.getAttribute("data-licence-plate-number"),
h=a.getAttribute("data-ticket-id"),l=a.getAttribute("data-record-date");cityssm.postJSON("/tickets/doReconcileAsError",{licencePlateCountry:b,licencePlateProvince:e,licencePlateNumber:c,ticketID:h,recordDate:l},function(a){a.success?(cityssm.clearElement(d),d.innerHTML='<div class="tags has-addons"><span class="tag is-light is-danger"><span class="icon is-small"><i class="fas fa-times" aria-hidden="true"></i></span><span>Match Error</span></span><a class="tag" data-tooltip="Remove Match" data-status-index="'+
a.statusIndex+'" data-tooltip="Remove Match" href="#"><i class="far fa-trash-alt" aria-hidden="true"></i><span class="sr-only">Remove Match</span></a></div>',d.getElementsByTagName("a")[0].addEventListener("click",k)):(f.removeAttribute("disabled"),pts.alertModal("Record Not Updated",a.message,"OK","danger"))})};if(a.hasAttribute("data-is-vehicle-make-match")||a.hasAttribute("data-is-licence-plate-expiry-date-match")){var c=a.getAttribute("data-ticket-vehicle"),e=a.getAttribute("data-ticket-expiry-date"),
h=a.getAttribute("data-owner-vehicle"),g=a.getAttribute("data-owner-expiry-date");pts.confirmModal("Confirm Error",'<p class="has-text-centered">Are you sure you want to mark an error between the details on the parking ticket and the details on the ownership record?</p><div class="columns has-margin-top-5">'+('<div class="column has-text-centered"><strong>Parking Ticket</strong><br /><span class="is-size-4">'+cityssm.escapeHTML(c)+'</span><br /><span class="is-size-5">'+(""===e?"(Not Set)":cityssm.escapeHTML(e))+
"</span></div>")+('<div class="column has-text-centered"><strong>Ownership Record</strong><br /><span class="is-size-4">'+cityssm.escapeHTML(h)+'</span><br /><span class="is-size-5">'+cityssm.escapeHTML(g)+"</span></div>")+"</div>","Yes, Confirm Error","warning",b)}else b()};c=document.getElementsByClassName("is-ownership-match-button");for(e=0;e<c.length;e+=1)c[e].addEventListener("click",g);c=document.getElementsByClassName("is-ownership-error-button");for(e=0;e<c.length;e+=1)c[e].addEventListener("click",
m);(c=document.getElementById("is-quick-reconcile-matches-button"))&&c.addEventListener("click",function(b){b.preventDefault();var e,d=function(){cityssm.postJSON("/tickets/doQuickReconcileMatches",{},function(a){e();if(a.success){pts.alertModal("Quick Reconcile Complete",1===a.statusRecords.length?"One record was successfully reconciled as a match.":a.statusRecords.length+" records were successfully reconciled as matches.","OK","success");for(var b=0;b<a.statusRecords.length;b+=1){var d=a.statusRecords[b],
c=document.getElementById("is-options-cell--"+d.ticketID);c&&(cityssm.clearElement(c),c.innerHTML='<div class="tags has-addons"><span class="tag is-light is-success"><span class="icon is-small"><i class="fas fa-check" aria-hidden="true"></i></span><span>Match</span></span><a class="tag" data-tooltip="Remove Match" data-status-index="'+d.statusIndex+'" data-tooltip="Remove Match" href="#"><i class="far fa-trash-alt" aria-hidden="true"></i><span class="sr-only">Remove Match</span></a></div>',c.getElementsByTagName("a")[0].addEventListener("click",
k))}}})};pts.confirmModal("Quick Reconcile Matches","Are you sure you want to mark all parking tickets with matching vehicle makes and plate expiry dates as matched?","Yes, Mark All Matches as Matched","info",function(){cityssm.openHtmlModal("loading",{onshown:function(a,b){document.getElementById("is-loading-modal-message").innerText="Reconciling matches...";e=b;d()}})})})})();
