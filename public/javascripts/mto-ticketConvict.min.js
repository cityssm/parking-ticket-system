"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),(()=>{const t="true"===document.getElementsByTagName("main")[0].getAttribute("data-can-update");let e=exports.currentBatch;delete exports.currentBatch;let a=exports.convictableTickets;delete exports.convictableTickets;const s=document.getElementById("filter--parkingTicket"),n=document.getElementById("convictable-tickets-container");let i=[];const c=t=>{t.preventDefault();const s=t.currentTarget;s.setAttribute("disabled","disabled");const n=parseInt(s.getAttribute("data-index"),10),i=a[n].ticketID;cityssm.postJSON("/tickets/doAddTicketToConvictionBatch",{batchID:e.batchID,ticketID:i},t=>{t.success?(e=t.batch,p(),a.splice(n,1),l()):(s.removeAttribute("disabled"),cityssm.alertModal("Ticket Not Added",t.message,"OK","danger"))})},o=t=>{let s;t.preventDefault();cityssm.openHtmlModal("loading",{onshow(){document.getElementById("is-loading-modal-message").innerText="Adding "+i.length.toString()+" ticket"+(1===i.length?"":"s")+"..."},onshown(t,n){s=n,cityssm.postJSON("/tickets-ontario/doAddAllTicketsToConvictionBatch",{batchID:e.batchID,ticketIDs:i},t=>{s(),t.batch&&(e=t.batch,p()),t.tickets&&(a=t.tickets,l()),0===t.successCount&&cityssm.alertModal("Results",t.message?t.message:"No tickets were added to the batch.","OK","warning")})}})},l=()=>{if(cityssm.clearElement(n),i=[],!e)return void(n.innerHTML='<div class="message is-warning"><div class="message-body">Select a target batch to get started.</div></div>');if(!t)return void(n.innerHTML='<div class="message is-warning"><div class="message-body">Parking tickets can only be added by users with update permissions.</div></div>');if(e.lockDate)return void(n.innerHTML='<div class="message is-warning"><div class="message-body">The target batch is locked and cannot accept additional tickets.</div></div>');if(0===a.length)return void(n.innerHTML='<div class="message is-info"><div class="message-body">There are no parking tickets currently eligible for conviction.</div></div>');const l=s.value.trim().toLowerCase(),r=document.createElement("tbody");if(a.forEach((t,e)=>{if(t.ticketNumber.toLowerCase().includes(l)&&t.licencePlateNumber.toLowerCase().includes(l))return;i.push(t.ticketID);const a=document.createElement("tr");a.innerHTML='<td><a data-tooltip="View Ticket (Opens in New Window)" href="/tickets/'+t.ticketID.toString()+'" target="_blank">'+cityssm.escapeHTML(t.ticketNumber)+"</a></td><td>"+t.issueDateString+'</td><td><span class="licence-plate-number is-size-6">'+cityssm.escapeHTML(t.licencePlateNumber)+'</span><br /><span class="has-tooltip-right is-size-7" data-tooltip="Primary Owner">'+cityssm.escapeHTML(t.licencePlateOwner_ownerName1)+'</span></td><td class="has-text-right"><button class="button is-small" data-index="'+e.toString()+'" type="button"><span class="icon is-small"><i class="fas fa-plus" aria-hidden="true"></i></span><span>Add</span></button></td>',a.getElementsByTagName("button")[0].addEventListener("click",c),r.appendChild(a)}),0===i.length)return void(n.innerHTML='<div class="message is-info"><div class="message-body">There are no parking tickets that meet the search criteria.</div></div>');const d=document.createElement("button");d.className="button is-fullwidth mb-3",d.innerHTML='<span class="icon is-small"><i class="fas fa-plus" aria-hidden="true"></i></span><span>Add '+i.length.toString()+" Parking Ticket"+(1===i.length?"":"s")+"</span>",d.addEventListener("click",o),n.appendChild(d);const h=document.createElement("table");h.className="table is-striped is-hoverable is-fullwidth",h.innerHTML="<thead><tr><th>Ticket Number</th><th>Issue Date</th><th>Licence Plate</th><th></th></tr></thead>",h.appendChild(r),n.appendChild(h)};s.addEventListener("keyup",l);const r=document.getElementById("batch-entries-container"),d=t=>{t.preventDefault();const s=t.currentTarget;s.setAttribute("disabled","disabled");const n=parseInt(s.getAttribute("data-index"),10),i=e.batchEntries[n].ticketID;cityssm.postJSON("/tickets-ontario/doRemoveTicketFromConvictionBatch",{batchID:e.batchID,ticketID:i},t=>{t.success?(e.batchEntries.splice(n,1),p(),a=t.tickets,l()):s.removeAttribute("disabled")})},h=t=>{t.preventDefault();cityssm.confirmModal("Clear Batch","Are you sure you want to remove all the parking tickets from the batch?","Yes, Clear the Batch","warning",()=>{cityssm.postJSON("/tickets-ontario/doClearConvictionBatch",{batchID:e.batchID},t=>{t.success||cityssm.alertModal("Batch Not Cleared",t.message,"OK","danger"),t.batch&&(e=t.batch,p()),t.tickets&&(a=t.tickets,l())})})},m=t=>{t.preventDefault();cityssm.confirmModal("Lock Batch?","<strong>Are you sure you want to lock this batch?</strong><br />Once locked, no further changes to the batch will be allowed. The option to download the batch will become available.","Yes, Lock the Batch","warning",()=>{cityssm.postJSON("/tickets/doLockConvictionBatch",{batchID:e.batchID},t=>{t.success&&(e.lockDate=t.lockDate,e.lockDateString=t.lockDateString,p(),l())})})},u=t=>{t.preventDefault();cityssm.confirmModal("Lock Batch?","<strong>Are you sure you want to unlock this batch?</strong><br />Once unlocked, changes to the batch will be allowed.","Yes, Unlock the Batch","warning",()=>{cityssm.postJSON("/tickets/doUnlockConvictionBatch",{batchID:e.batchID},t=>{t.success&&(e.lockDate=null,e.lockDateString=null,p(),l())})})},b=t=>{t.preventDefault();const a=()=>{window.open("/tickets-ontario/convict/"+e.batchID.toString())};e.sentDate?a():cityssm.confirmModal("Download Batch","<strong>You are about to download the batch for the first time.</strong><br />Once downloaded, the date will be tracked, and the batch will no longer be able to be unlocked.","Yes, Download the Batch","warning",()=>{a();const t=new Date;e.sentDateString=cityssm.dateToString(t),e.sentDate=parseInt(e.sentDateString.replace(/-/g,""),10),p()})},p=()=>{if(document.getElementById("batchSelector--batchID").innerText="Batch #"+e.batchID.toString(),document.getElementById("batchSelector--batchDetails").innerHTML='<span class="has-tooltip-left" data-tooltip="Batch Date"><span class="icon"><i class="fas fa-star" aria-hidden="true"></i></span> '+e.batchDateString+"</span>"+(e.lockDate?'<br /><span class="has-tooltip-left" data-tooltip="Lock Date"><span class="icon"><i class="fas fa-lock" aria-hidden="true"></i></span> '+e.lockDateString+"</span>":""),cityssm.clearElement(r),0===e.batchEntries.length)return void(r.innerHTML='<div class="message is-info"><div class="message-body">There are no parking tickets in this batch.</div></div>');const a=document.createElement("tbody"),s=t&&!e.lockDate;e.batchEntries.forEach((t,e)=>{const n=document.createElement("tr");n.innerHTML='<td><a href="/tickets/'+t.ticketID.toString()+'" target="_blank">'+t.ticketNumber+"</a></td><td>"+t.issueDateString+'</td><td><span class="licence-plate-number is-size-6">'+cityssm.escapeHTML(t.licencePlateNumber)+"</span></td>"+(s?'<td class="has-text-right"><button class="button is-small" data-index="'+e.toString()+'" type="button"><span class="icon is-small"><i class="fas fa-minus" aria-hidden="true"></i></span><span>Remove</span></button></td>':""),s&&n.getElementsByTagName("button")[0].addEventListener("click",d),a.appendChild(n)});const n=document.createElement("table");if(n.className="table is-fullwidth is-striped is-hoverable",n.innerHTML="<thead><tr><th>Ticket Number</th><th>Issue Date</th><th>Licence Plate</th>"+(s?"<th></th>":"")+"</tr></thead>",n.appendChild(a),r.appendChild(n),t&&!e.lockDate){const t=document.createElement("button");t.className="button is-fullwidth mb-3",t.innerHTML='<span class="icon is-small"><i class="fas fa-lock" aria-hidden="true"></i></span><span>Lock Batch</span>',t.addEventListener("click",m),r.insertAdjacentElement("afterbegin",t);const e=document.createElement("button");e.className="button is-fullwidth mb-3",e.innerHTML='<span class="icon is-small"><i class="fas fa-broom" aria-hidden="true"></i></span><span>Clear Batch</span>',e.addEventListener("click",h),n.insertAdjacentElement("beforebegin",e)}if(t&&e.lockDate&&!e.sentDate){const t=document.createElement("button");t.className="button is-fullwidth mb-3",t.innerHTML='<span class="icon is-small"><i class="fas fa-unlock" aria-hidden="true"></i></span><span>Unlock Batch</span>',t.addEventListener("click",u),r.insertAdjacentElement("afterbegin",t)}if(e.lockDate){const t=document.createElement("button");t.className="button is-fullwidth mb-3",t.innerHTML='<span class="icon is-small"><i class="fas fa-download" aria-hidden="true"></i></span><span>Download File for MTO</span>',t.addEventListener("click",b),n.insertAdjacentElement("beforebegin",t),n.insertAdjacentHTML("beforebegin",'<a class="button is-fullwidth mb-3" href="https://www.apps.rus.mto.gov.on.ca/edtW/login/login.jsp" target="_blank" rel="noreferrer"><span class="icon is-small"><i class="fas fa-building" aria-hidden="true"></i></span><span>MTO ARIS Login</span></a>')}};document.getElementById("is-select-batch-button").addEventListener("click",a=>{let s;a.preventDefault();const n=t=>{t.preventDefault();const a=t.currentTarget.getAttribute("data-batch-id");cityssm.postJSON("/tickets/doGetConvictionBatch",{batchID:a},t=>{e=t,p(),l()}),s()};cityssm.openHtmlModal("mto-selectBatch",{onshow(a){if(t){const t=a.getElementsByClassName("is-create-batch-button")[0];t.classList.remove("is-hidden"),t.addEventListener("click",t=>{t.preventDefault(),s(),cityssm.confirmModal("Create a New Batch","Are you sure you want to create a new conviction batch?","Yes, Create Batch","info",()=>{cityssm.postJSON("/tickets/doCreateConvictionBatch",{},t=>{t.success&&(e=t.batch,p(),l())})})})}cityssm.postJSON("/tickets/doGetRecentConvictionBatches",[],t=>{const e=a.getElementsByClassName("is-results-container")[0];if(cityssm.clearElement(e),0===t.length)return e.className="message is-info",void(e.innerHTML='<div class="message-body">There are no recent conviction batches.</div>');e.className="list is-hoverable";for(const a of t){const t=document.createElement("a");t.className="list-item",t.setAttribute("data-batch-id",a.batchID.toString()),t.href="#",t.innerHTML='<div class="columns"><div class="column is-narrow">#'+a.batchID.toString()+'</div><div class="column has-text-right">'+a.batchDateString+(a.lockDate?'<br /><div class="tags justify-flex-end"><span class="tag"><span class="icon is-small"><i class="fas fa-lock" aria-hidden="true"></i></span><span>Locked</span></span>':"")+"</div></div>",t.addEventListener("click",n),e.appendChild(t)}})},onshown(t,e){s=e}})}),e&&p(),l()})();