"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),(()=>{var t;const e="true"===document.querySelectorAll("main")[0].dataset.canUpdate;let n=exports.currentBatch;delete exports.currentBatch;let a=exports.convictableTickets;delete exports.convictableTickets;const s=document.querySelector("#filter--parkingTicket"),c=document.querySelector("#convictable-tickets-container");let i=[];function o(t){var e;t.preventDefault();const s=t.currentTarget;s.setAttribute("disabled","disabled");const c=Number.parseInt(null!==(e=s.dataset.index)&&void 0!==e?e:"-1",10),i=a[c].ticketId;cityssm.postJSON("/tickets/doAddTicketToConvictionBatch",{batchId:n.batchId,ticketId:i},t=>{var e;t.success?(n=t.batch,v(),a.splice(c,1),r()):(s.removeAttribute("disabled"),cityssm.alertModal("Ticket Not Added",null!==(e=t.message)&&void 0!==e?e:"","OK","danger"))})}function l(t){let e;t.preventDefault(),cityssm.openHtmlModal("loading",{onshow(){document.querySelector("#is-loading-modal-message").textContent=`Adding ${i.length.toString()}\n          ticket${1===i.length?"":"s"}...`},onshown(t,s){e=s,cityssm.postJSON("/tickets-ontario/doAddAllTicketsToConvictionBatch",{batchId:n.batchId,ticketIds:i},t=>{var s;e(),t.batch&&(n=t.batch,v()),t.tickets&&(a=t.tickets,r()),0===t.successCount&&cityssm.alertModal("Results",null!==(s=t.message)&&void 0!==s?s:"No tickets were added to the batch.","OK","warning")})}})}function r(){var t,r;if(cityssm.clearElement(c),i=[],!n)return void(c.innerHTML='<div class="message is-warning">\n        <div class="message-body">Select a target batch to get started.</div>\n        </div>');if(!e)return void(c.innerHTML='<div class="message is-warning">\n        <div class="message-body">Parking tickets can only be added by users with update permissions.</div>\n        </div>');if(n.lockDate)return void(c.innerHTML='<div class="message is-warning">\n        <div class="message-body">The target batch is locked and cannot accept additional tickets.</div>\n        </div>');if(0===a.length)return void(c.innerHTML='<div class="message is-info">\n        <div class="message-body">There are no parking tickets currently eligible for conviction.</div>\n        </div>');const d=s.value.trim().toLowerCase(),u=document.createElement("tbody");for(const[e,n]of a.entries()){if(!n.ticketNumber.toLowerCase().includes(d)&&!n.licencePlateNumber.toLowerCase().includes(d))continue;i.push(n.ticketId);const a=document.createElement("tr");a.innerHTML=`<td>\n          <a data-tooltip="View Ticket (Opens in New Window)" href="/tickets/${n.ticketId.toString()}" target="_blank">\n          ${cityssm.escapeHTML(n.ticketNumber)}\n          </a>\n        </td>\n        <td>${n.issueDateString}</td>\n        <td>\n          <span class="licence-plate-number is-size-6">\n          ${cityssm.escapeHTML(n.licencePlateNumber)}\n          </span><br />\n          <span class="has-tooltip-right is-size-7" data-tooltip="Primary Owner">\n          ${cityssm.escapeHTML(null!==(t=n.licencePlateOwner_ownerName1)&&void 0!==t?t:"")}\n          </span>\n        </td>\n        <td class="has-text-right">\n          <button class="button is-small" data-index="${e.toString()}" type="button">\n            <span class="icon is-small"><i class="fas fa-plus" aria-hidden="true"></i></span>\n            <span>Add</span>\n          </button>\n        </td>`,null===(r=a.querySelector("button"))||void 0===r||r.addEventListener("click",o),u.append(a)}if(0===i.length)return void(c.innerHTML='<div class="message is-info">\n        <div class="message-body">There are no parking tickets that meet the search criteria.</div>\n        </div>');const h=document.createElement("button");h.className="button is-fullwidth mb-3",h.innerHTML=`<span class="icon is-small"><i class="fas fa-plus" aria-hidden="true"></i></span>\n      <span>\n        Add ${i.length.toString()}\n        Parking Ticket${1===i.length?"":"s"}\n      </span>`,h.addEventListener("click",l),c.append(h);const m=document.createElement("table");m.className="table is-striped is-hoverable is-fullwidth",m.innerHTML="<thead><tr>\n      <th>Ticket Number</th>\n      <th>Issue Date</th>\n      <th>Licence Plate</th>\n      <th></th>\n      </tr></thead>",m.append(u),c.append(m)}s.addEventListener("keyup",r);const d=document.querySelector("#batch-entries-container");function u(t){var e;t.preventDefault();const s=t.currentTarget;s.setAttribute("disabled","disabled");const c=Number.parseInt(null!==(e=s.dataset.index)&&void 0!==e?e:"-1",10),i=n.batchEntries[c].ticketId;cityssm.postJSON("/tickets-ontario/doRemoveTicketFromConvictionBatch",{batchId:n.batchId,ticketId:i},t=>{t.success?(n.batchEntries.splice(c,1),v(),a=t.tickets,r()):s.removeAttribute("disabled")})}function h(t){t.preventDefault(),cityssm.confirmModal("Clear Batch","Are you sure you want to remove all the parking tickets from the batch?","Yes, Clear the Batch","warning",function(){cityssm.postJSON("/tickets-ontario/doClearConvictionBatch",{batchId:n.batchId},t=>{var e;t.success||cityssm.alertModal("Batch Not Cleared",null!==(e=t.message)&&void 0!==e?e:"","OK","danger"),t.batch&&(n=t.batch,v()),t.tickets&&(a=t.tickets,r())})})}function m(t){t.preventDefault(),cityssm.confirmModal("Lock Batch?","<strong>Are you sure you want to lock this batch?</strong><br />Once locked, no further changes to the batch will be allowed. The option to download the batch will become available.","Yes, Lock the Batch","warning",function(){cityssm.postJSON("/tickets/doLockConvictionBatch",{batchId:n.batchId},t=>{t.success&&(n.lockDate=t.lockDate,n.lockDateString=t.lockDateString,v(),r())})})}function b(t){t.preventDefault(),cityssm.confirmModal("Lock Batch?","<strong>Are you sure you want to unlock this batch?</strong><br />Once unlocked, changes to the batch will be allowed.","Yes, Unlock the Batch","warning",function(){cityssm.postJSON("/tickets/doUnlockConvictionBatch",{batchId:n.batchId},t=>{t.success&&(n.lockDate=void 0,n.lockDateString=void 0,v(),r())})})}function p(t){function e(){window.open(`/tickets/convict/${n.batchId.toString()}/print`)}t.preventDefault(),n.sentDate?e():cityssm.confirmModal("Download Batch","<strong>You are about to download the batch for the first time.</strong><br />Once downloaded, the date will be tracked, and the batch will no longer be able to be unlocked.","Yes, Download the Batch","warning",()=>{cityssm.postJSON("/tickets/doMarkConvictionBatchSent",{batchId:n.batchId},t=>{n=t.batch,v()}),e()})}function v(){var t,a;if(document.querySelector("#batchSelector--batchId").textContent="Batch #"+n.batchId.toString(),document.querySelector("#batchSelector--batchDetails").innerHTML='<span class="has-tooltip-left" data-tooltip="Batch Date"><span class="icon"><i class="fas fa-star" aria-hidden="true"></i></span> '+n.batchDateString+"</span>"+(n.lockDate?'<br /><span class="has-tooltip-left" data-tooltip="Lock Date"><span class="icon"><i class="fas fa-lock" aria-hidden="true"></i></span> '+n.lockDateString+"</span>":""),cityssm.clearElement(d),0===n.batchEntries.length)return void(d.innerHTML='<div class="message is-info"><div class="message-body">There are no parking tickets in this batch.</div></div>');const s=document.createElement("tbody"),c=e&&!n.lockDate;for(const[e,i]of(null!==(t=n.batchEntries)&&void 0!==t?t:[]).entries()){const t=document.createElement("tr");t.innerHTML='<td><a href="/tickets/'+i.ticketId.toString()+'" target="_blank">'+i.ticketNumber+"</a></td><td>"+i.issueDateString+'</td><td><span class="licence-plate-number is-size-6">'+cityssm.escapeHTML(i.licencePlateNumber)+"</span></td>"+(c?`<td class="has-text-right">\n              <button class="button is-small" data-index="${e.toString()}" type="button">\n              <span class="icon is-small"><i class="fas fa-minus" aria-hidden="true"></i></span>\n              <span>Remove</span>\n              </button>\n              </td>`:""),c&&(null===(a=t.querySelector("button"))||void 0===a||a.addEventListener("click",u)),s.append(t)}const i=document.createElement("table");if(i.className="table is-fullwidth is-striped is-hoverable",i.innerHTML=`<thead><tr>\n      <th>Ticket Number</th>\n      <th>Issue Date</th>\n      <th>Licence Plate</th>\n      ${c?"<th></th>":""}\n      </tr></thead>`,i.append(s),d.append(i),e&&!n.lockDate){const t=document.createElement("button");t.className="button is-fullwidth mb-3",t.innerHTML='<span class="icon is-small">\n        <i class="fas fa-lock" aria-hidden="true"></i>\n        </span>\n        <span>Lock Batch</span>',t.addEventListener("click",m),d.prepend(t);const e=document.createElement("button");e.className="button is-fullwidth mb-3",e.innerHTML='<span class="icon is-small">\n        <i class="fas fa-broom" aria-hidden="true"></i>\n        </span>\n        <span>Clear Batch</span>',e.addEventListener("click",h),i.before(e)}if(e&&n.lockDate&&!n.sentDate){const t=document.createElement("button");t.className="button is-fullwidth mb-3",t.innerHTML='<span class="icon is-small"><i class="fas fa-unlock" aria-hidden="true"></i></span>\n        <span>Unlock Batch</span>',t.addEventListener("click",b),d.prepend(t)}if(n.lockDate){const t=document.createElement("button");t.className="button is-fullwidth mb-3",t.innerHTML='<span class="icon is-small">\n        <i class="fas fa-download" aria-hidden="true"></i>\n        </span>\n        <span>Download Report for Provincial Offences</span>',t.addEventListener("click",p),i.before(t)}}null===(t=document.querySelector("#is-select-batch-button"))||void 0===t||t.addEventListener("click",t=>{let a;function s(t){t.preventDefault();const e=t.currentTarget.dataset.batchId;cityssm.postJSON("/tickets/doGetConvictionBatch",{batchId:e},t=>{n=t,v(),r()}),a()}t.preventDefault(),cityssm.openHtmlModal("mto-selectBatch",{onshow(t){if(e){const e=t.querySelector(".is-create-batch-button");e.classList.remove("is-hidden"),e.addEventListener("click",t=>{t.preventDefault(),a(),cityssm.confirmModal("Create a New Batch","Are you sure you want to create a new conviction batch?","Yes, Create Batch","info",function(){cityssm.postJSON("/tickets/doCreateConvictionBatch",{},t=>{t.success&&(n=t.batch,v(),r())})})})}cityssm.postJSON("/tickets/doGetRecentConvictionBatches",{},e=>{const n=t.querySelector(".is-results-container");if(cityssm.clearElement(n),0===e.length)return n.className="message is-info",void(n.innerHTML='<div class="message-body">There are no recent conviction batches.</div>');n.className="list is-hoverable";for(const t of e){const e=document.createElement("a");e.className="list-item",e.dataset.batchId=t.batchId.toString(),e.href="#",e.innerHTML='<div class="columns"><div class="column is-narrow">#'+t.batchId.toString()+'</div><div class="column has-text-right">'+t.batchDateString+(t.lockDate?'<br />\n                      <div class="tags justify-flex-end">\n                        <span class="tag">\n                          <span class="icon is-small"><i class="fas fa-lock" aria-hidden="true"></i></span>\n                          <span>Locked</span>\n                        </span>\n                      </div>':"")+"</div></div>",e.addEventListener("click",s),n.append(e)}})},onshown(t,e){a=e}})}),n&&v(),r()})();