"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),(()=>{const t="true"===document.querySelectorAll("main")[0].getAttribute("data-can-update");let e=exports.currentBatch;delete exports.currentBatch;let s=exports.convictableTickets;delete exports.convictableTickets;const a=document.querySelector("#filter--parkingTicket"),n=document.querySelector("#convictable-tickets-container");let c=[];const i=t=>{t.preventDefault();const a=t.currentTarget;a.setAttribute("disabled","disabled");const n=Number.parseInt(a.getAttribute("data-index"),10),c=s[n].ticketID;cityssm.postJSON("/tickets/doAddTicketToConvictionBatch",{batchID:e.batchID,ticketID:c},t=>{t.success?(e=t.batch,p(),s.splice(n,1),r()):(a.removeAttribute("disabled"),cityssm.alertModal("Ticket Not Added",t.message,"OK","danger"))})},o=t=>{let a;t.preventDefault();cityssm.openHtmlModal("loading",{onshow(){document.querySelector("#is-loading-modal-message").textContent="Adding "+c.length.toString()+" ticket"+(1===c.length?"":"s")+"..."},onshown(t,n){a=n,cityssm.postJSON("/tickets-ontario/doAddAllTicketsToConvictionBatch",{batchID:e.batchID,ticketIDs:c},t=>{a(),t.batch&&(e=t.batch,p()),t.tickets&&(s=t.tickets,r()),0===t.successCount&&cityssm.alertModal("Results",t.message?t.message:"No tickets were added to the batch.","OK","warning")})}})},r=()=>{if(cityssm.clearElement(n),c=[],!e)return void(n.innerHTML='<div class="message is-warning"><div class="message-body">Select a target batch to get started.</div></div>');if(!t)return void(n.innerHTML='<div class="message is-warning"><div class="message-body">Parking tickets can only be added by users with update permissions.</div></div>');if(e.lockDate)return void(n.innerHTML='<div class="message is-warning"><div class="message-body">The target batch is locked and cannot accept additional tickets.</div></div>');if(0===s.length)return void(n.innerHTML='<div class="message is-info"><div class="message-body">There are no parking tickets currently eligible for conviction.</div></div>');const r=a.value.trim().toLowerCase(),l=document.createElement("tbody");for(const[t,e]of s.entries()){if(!e.ticketNumber.toLowerCase().includes(r)&&!e.licencePlateNumber.toLowerCase().includes(r))continue;c.push(e.ticketID);const s=document.createElement("tr");s.innerHTML='<td><a data-tooltip="View Ticket (Opens in New Window)" href="/tickets/'+e.ticketID.toString()+'" target="_blank">'+cityssm.escapeHTML(e.ticketNumber)+"</a></td><td>"+e.issueDateString+'</td><td><span class="licence-plate-number is-size-6">'+cityssm.escapeHTML(e.licencePlateNumber)+'</span><br /><span class="has-tooltip-right is-size-7" data-tooltip="Primary Owner">'+cityssm.escapeHTML(e.licencePlateOwner_ownerName1)+'</span></td><td class="has-text-right"><button class="button is-small" data-index="'+t.toString()+'" type="button"><span class="icon is-small"><i class="fas fa-plus" aria-hidden="true"></i></span><span>Add</span></button></td>',s.querySelector("button").addEventListener("click",i),l.append(s)}if(0===c.length)return void(n.innerHTML='<div class="message is-info"><div class="message-body">There are no parking tickets that meet the search criteria.</div></div>');const d=document.createElement("button");d.className="button is-fullwidth mb-3",d.innerHTML='<span class="icon is-small"><i class="fas fa-plus" aria-hidden="true"></i></span><span>Add '+c.length.toString()+" Parking Ticket"+(1===c.length?"":"s")+"</span>",d.addEventListener("click",o),n.append(d);const h=document.createElement("table");h.className="table is-striped is-hoverable is-fullwidth",h.innerHTML="<thead><tr><th>Ticket Number</th><th>Issue Date</th><th>Licence Plate</th><th></th></tr></thead>",h.append(l),n.append(h)};a.addEventListener("keyup",r);const l=document.querySelector("#batch-entries-container"),d=t=>{t.preventDefault();const a=t.currentTarget;a.setAttribute("disabled","disabled");const n=Number.parseInt(a.getAttribute("data-index"),10),c=e.batchEntries[n].ticketID;cityssm.postJSON("/tickets-ontario/doRemoveTicketFromConvictionBatch",{batchID:e.batchID,ticketID:c},t=>{t.success?(e.batchEntries.splice(n,1),p(),s=t.tickets,r()):a.removeAttribute("disabled")})},h=t=>{t.preventDefault();cityssm.confirmModal("Clear Batch","Are you sure you want to remove all the parking tickets from the batch?","Yes, Clear the Batch","warning",()=>{cityssm.postJSON("/tickets-ontario/doClearConvictionBatch",{batchID:e.batchID},t=>{t.success||cityssm.alertModal("Batch Not Cleared",t.message,"OK","danger"),t.batch&&(e=t.batch,p()),t.tickets&&(s=t.tickets,r())})})},u=t=>{t.preventDefault();cityssm.confirmModal("Lock Batch?","<strong>Are you sure you want to lock this batch?</strong><br />Once locked, no further changes to the batch will be allowed. The option to download the batch will become available.","Yes, Lock the Batch","warning",()=>{cityssm.postJSON("/tickets/doLockConvictionBatch",{batchID:e.batchID},t=>{t.success&&(e.lockDate=t.lockDate,e.lockDateString=t.lockDateString,p(),r())})})},m=t=>{t.preventDefault();cityssm.confirmModal("Lock Batch?","<strong>Are you sure you want to unlock this batch?</strong><br />Once unlocked, changes to the batch will be allowed.","Yes, Unlock the Batch","warning",()=>{cityssm.postJSON("/tickets/doUnlockConvictionBatch",{batchID:e.batchID},t=>{t.success&&(e.lockDate=void 0,e.lockDateString=void 0,p(),r())})})},b=t=>{t.preventDefault();const s=()=>{window.open("/tickets/convict/"+e.batchID.toString()+"/print")};e.sentDate?s():cityssm.confirmModal("Download Batch","<strong>You are about to download the batch for the first time.</strong><br />Once downloaded, the date will be tracked, and the batch will no longer be able to be unlocked.","Yes, Download the Batch","warning",()=>{s();const t=new Date;e.sentDateString=cityssm.dateToString(t),e.sentDate=Number.parseInt(e.sentDateString.replace(/-/g,""),10),p()})},p=()=>{if(document.querySelector("#batchSelector--batchID").textContent="Batch #"+e.batchID.toString(),document.querySelector("#batchSelector--batchDetails").innerHTML='<span class="has-tooltip-left" data-tooltip="Batch Date"><span class="icon"><i class="fas fa-star" aria-hidden="true"></i></span> '+e.batchDateString+"</span>"+(e.lockDate?'<br /><span class="has-tooltip-left" data-tooltip="Lock Date"><span class="icon"><i class="fas fa-lock" aria-hidden="true"></i></span> '+e.lockDateString+"</span>":""),cityssm.clearElement(l),0===e.batchEntries.length)return void(l.innerHTML='<div class="message is-info"><div class="message-body">There are no parking tickets in this batch.</div></div>');const s=document.createElement("tbody"),a=t&&!e.lockDate;for(const[t,n]of e.batchEntries.entries()){const e=document.createElement("tr");e.innerHTML='<td><a href="/tickets/'+n.ticketID.toString()+'" target="_blank">'+n.ticketNumber+"</a></td><td>"+n.issueDateString+'</td><td><span class="licence-plate-number is-size-6">'+cityssm.escapeHTML(n.licencePlateNumber)+"</span></td>"+(a?'<td class="has-text-right"><button class="button is-small" data-index="'+t.toString()+'" type="button"><span class="icon is-small"><i class="fas fa-minus" aria-hidden="true"></i></span><span>Remove</span></button></td>':""),a&&e.querySelector("button").addEventListener("click",d),s.append(e)}const n=document.createElement("table");if(n.className="table is-fullwidth is-striped is-hoverable",n.innerHTML="<thead><tr><th>Ticket Number</th><th>Issue Date</th><th>Licence Plate</th>"+(a?"<th></th>":"")+"</tr></thead>",n.append(s),l.append(n),t&&!e.lockDate){const t=document.createElement("button");t.className="button is-fullwidth mb-3",t.innerHTML='<span class="icon is-small"><i class="fas fa-lock" aria-hidden="true"></i></span><span>Lock Batch</span>',t.addEventListener("click",u),l.prepend(t);const e=document.createElement("button");e.className="button is-fullwidth mb-3",e.innerHTML='<span class="icon is-small"><i class="fas fa-broom" aria-hidden="true"></i></span><span>Clear Batch</span>',e.addEventListener("click",h),n.before(e)}if(t&&e.lockDate&&!e.sentDate){const t=document.createElement("button");t.className="button is-fullwidth mb-3",t.innerHTML='<span class="icon is-small"><i class="fas fa-unlock" aria-hidden="true"></i></span><span>Unlock Batch</span>',t.addEventListener("click",m),l.prepend(t)}if(e.lockDate){const t=document.createElement("button");t.className="button is-fullwidth mb-3",t.innerHTML='<span class="icon is-small"><i class="fas fa-download" aria-hidden="true"></i></span><span>Download Report for Provincial Offences</span>',t.addEventListener("click",b),n.before(t)}};document.querySelector("#is-select-batch-button").addEventListener("click",s=>{let a;s.preventDefault();const n=t=>{t.preventDefault();const s=t.currentTarget.dataset.batchId;cityssm.postJSON("/tickets/doGetConvictionBatch",{batchID:s},t=>{e=t,p(),r()}),a()};cityssm.openHtmlModal("mto-selectBatch",{onshow(s){if(t){const t=s.querySelector(".is-create-batch-button");t.classList.remove("is-hidden"),t.addEventListener("click",t=>{t.preventDefault(),a(),cityssm.confirmModal("Create a New Batch","Are you sure you want to create a new conviction batch?","Yes, Create Batch","info",()=>{cityssm.postJSON("/tickets/doCreateConvictionBatch",{},t=>{t.success&&(e=t.batch,p(),r())})})})}cityssm.postJSON("/tickets/doGetRecentConvictionBatches",[],t=>{const e=s.querySelector(".is-results-container");if(cityssm.clearElement(e),0===t.length)return e.className="message is-info",void(e.innerHTML='<div class="message-body">There are no recent conviction batches.</div>');e.className="list is-hoverable";for(const s of t){const t=document.createElement("a");t.className="list-item",t.dataset.batchId=s.batchID.toString(),t.href="#",t.innerHTML='<div class="columns"><div class="column is-narrow">#'+s.batchID.toString()+'</div><div class="column has-text-right">'+s.batchDateString+(s.lockDate?'<br /><div class="tags justify-flex-end"><span class="tag"><span class="icon is-small"><i class="fas fa-lock" aria-hidden="true"></i></span><span>Locked</span></span>':"")+"</div></div>",t.addEventListener("click",n),e.append(t)}})},onshown(t,e){a=e}})}),e&&p(),r()})();