(function(){function v(a){a.preventDefault();var b=parseInt(a.currentTarget.getAttribute("data-index")),c=m[b],f=a.currentTarget.closest(".is-plate-container");pts.postJSON("/plates/doAddLicencePlateToLookupBatch",{batchID:h,licencePlateCountry:"CA",licencePlateProvince:"ON",licencePlateNumber:c.licencePlateNumber,ticketID:c.ticketIDMin},function(a){a.success&&(f.remove(),m[b]=null,k(a.batch))})}function w(a){a.preventDefault();var b=parseInt(a.currentTarget.getAttribute("data-index")),b=e[b],c=a.currentTarget.closest(".is-entry-container");
pts.postJSON("/plates/doRemoveLicencePlateFromLookupBatch",{batchID:h,licencePlateCountry:"CA",licencePlateProvince:"ON",licencePlateNumber:b.licencePlateNumber},function(a){a.success&&(c.remove(),l())})}function x(a){a.preventDefault();pts.confirmModal("Clear Batch?","Are you sure you want to remove all licence plates from the batch?","Yes, Clear the Batch","warning",function(){pts.postJSON("/plates/doClearLookupBatch",{batchID:h},function(a){a.success&&(k(a.batch),l())})})}function y(a,b){return a+
'<a class="tag has-tooltip-bottom" data-tooltip="View Ticket (Opens in New Window)" href="/tickets/byTicketNumber/'+encodeURIComponent(b)+'" target="_blank">'+pts.escapeHTML(b)+"</a> "}function r(){pts.clearElement(n);var a=document.createElement("div");a.className="panel";for(var b=t.value.toLowerCase().trim().split(" "),c=[],f=0;f<m.length;f+=1){var d=m[f];if(d){for(var g=!0,e=d.licencePlateNumber.toLowerCase(),q=0;q<b.length;q+=1)if(-1===e.indexOf(b[q])){g=!1;break}g&&(c.push([d.licencePlateNumber,
d.ticketIDMin]),g=document.createElement("div"),g.className="panel-block is-block is-plate-container",g.innerHTML='<div class="level is-marginless">'+('<div class="level-left"><div class="licence-plate"><div class="licence-plate-number">'+pts.escapeHTML(d.licencePlateNumber)+"</div></div></div>")+('<div class="level-right"><button class="button is-small" data-index="'+f+'" data-tooltip="Add to Batch" type="button"><span class="icon is-small"><i class="fas fa-plus" aria-hidden="true"></i></span><span>Add</span></button></div>')+
'</div><div class="level"><div class="level-left"><div class="tags">'+d.ticketNumbers.reduce(y,"")+'</div></div><div class="level-right is-size-7">'+d.issueDateMinString+(d.issueDateMin===d.issueDateMax?"":" to "+d.issueDateMaxString)+"</div></div>",g.getElementsByTagName("button")[0].addEventListener("click",v),a.appendChild(g))}}0<c.length?(b=document.createElement("button"),b.className="button is-fullwidth has-margin-bottom-10",b.innerHTML='<span class="icon is-small"><i class="fas fa-plus" aria-hidden="true"></i></span><span>Add '+
c.length+" Licence Plate"+(1===c.length?"":"s")+"</span>",b.addEventListener("click",function(){pts.openHtmlModal("loading",{onshown:function(a,b){document.getElementById("is-loading-modal-message").innerText="Adding "+c.length+" Licence Plate"+(1===c.length?"":"s")+"...";pts.postJSON("/plates/doAddAllLicencePlatesToLookupBatch",{batchID:h,licencePlateCountry:"CA",licencePlateProvince:"ON",licencePlateNumbers:c},function(a){b();a.success&&(k(a.batch),l())})}})}),n.appendChild(b),n.appendChild(a)):
n.innerHTML='<div class="message is-info"><div class="message-body">There are no licence plates that meet your search criteria.</div></div>'}var h=-1,k,l,u=document.getElementById("available--issueDaysAgo"),n=document.getElementById("is-available-plates-container"),t=document.getElementById("available--licencePlateNumber"),m=[],e=[];l=function(){n.innerHTML='<p class="has-text-centered has-text-grey-lighter"><i class="fas fa-3x fa-circle-notch fa-spin" aria-hidden="true"></i><br /><em>Loading licence plates...</p>';
pts.postJSON("/plates/mto_doGetPlatesAvailableForLookup",{batchID:h,issueDaysAgo:u.value},function(a){m=a;r()})};document.getElementById("is-more-available-filters-toggle").addEventListener("click",function(a){a.preventDefault();a=document.getElementById("is-more-available-filters");a.classList.toggle("is-block");a.classList.toggle("is-hidden")});t.addEventListener("keyup",r);u.addEventListener("change",l);var p=document.getElementById("is-batch-entries-container");k=function(a){h=a.batchID;e=a.batchEntries;
document.getElementById("batchSelector--batchID").innerText="Batch #"+a.batchID;document.getElementById("batchSelector--batchDetails").innerHTML="Created "+a.batchDateString;pts.clearElement(p);if(0===e.length)p.innerHTML='<div class="message is-info"><p class="message-body">There are no licence plates included in the batch.</p></div>';else{pts.clearElement(p);a=document.createElement("div");a.className="panel";for(var b=0;b<e.length;b+=1){var c=e[b],f=document.createElement("div");f.className="panel-block is-block is-entry-container";
f.innerHTML='<div class="level">'+('<div class="level-left"><div class="licence-plate"><div class="licence-plate-number">'+pts.escapeHTML(c.licencePlateNumber)+"</div></div></div>")+('<div class="level-right"><button class="button is-small" data-index="'+b+'" type="button"><span class="icon is-small"><i class="fas fa-minus" aria-hidden="true"></i></span><span>Remove</span></button></div>')+"</div>";f.getElementsByTagName("button")[0].addEventListener("click",w);a.appendChild(f)}b=document.createElement("button");
b.className="button is-fullwidth has-margin-bottom-10";b.innerHTML='<span class="icon is-small"><i class="fas fa-broom" aria-hidden="true"></i></span><span>Clear '+e.length+" Entr"+(1===e.length?"y":"ies")+" from Batch</span>";b.addEventListener("click",x);p.appendChild(b);p.appendChild(a)}};document.getElementById("is-select-batch-button").addEventListener("click",function(a){a.preventDefault();var b,c,f=function(a){a.preventDefault();h=parseInt(a.currentTarget.getAttribute("data-batch-id"));b();
pts.postJSON("/plates/doGetLookupBatch",{batchID:h},k);l()},d=function(){pts.postJSON("/plates/doGetUnsentLicencePlateLookupBatches",{},function(a){if(0===a.length)c.innerHTML='<div class="message is-info"><p class="message-body">There are no unsent batches available.</p></div>';else{var b=document.createElement("div");b.className="list is-hoverable";for(var d=0;d<a.length;d+=1){var g=a[d],e=document.createElement("a");e.className="list-item";e.setAttribute("href","#");e.setAttribute("data-batch-id",
g.batchID);e.innerHTML='<div class="columns"><div class="column is-narrow">#'+g.batchID+'</div><div class="column has-text-right">'+g.batchDateString+(g.lockDate?'<br /><span class="tag">Locked</span>':"")+"</div></div>";e.addEventListener("click",f);b.appendChild(e)}pts.clearElement(c);c.appendChild(b)}})};pts.openHtmlModal("mto-selectBatch",{onshow:function(a){c=a.getElementsByClassName("is-results-container")[0];d()},onshown:function(a,c){b=c}})});document.getElementById("is-create-batch-button").addEventListener("click",
function(){pts.confirmModal("Create a New Batch?","Are you sure you want to create a new licence plate lookup batch?","Yes, Create a Batch","info",function(){pts.postJSON("/plates/doCreateLookupBatch",{},function(a){a.success&&k(a.batch)})})});pts.plateExportBatch&&(k(pts.plateExportBatch),delete pts.plateExportBatch,l())})();
