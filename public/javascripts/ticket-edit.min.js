"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),function(){for(var e=document.getElementById("ticket--ticketID").value,t=""===e,s=document.getElementById("container--form-message"),a=function(){cityssm.enableNavBlocker(),!0,s.innerHTML='<span class="tag is-light is-info is-medium"><span class="icon"><i class="fas fa-exclamation-triangle" aria-hidden="true"></i></span> <span>Unsaved Changes</span></div>'},n=document.querySelectorAll(".input, .select, .textarea"),i=0;i<n.length;i+=1)n[i].addEventListener("change",a);document.getElementById("form--ticket").addEventListener("submit",function(e){e.preventDefault();var n=document.getElementById("ticket--ticketNumber").value;s.innerHTML='<span class="tag is-light is-info is-medium"><span>Saving ticket... </span> <span class="icon"><i class="fas fa-circle-notch fa-spin" aria-hidden="true"></i></span></div>',cityssm.postJSON(t?"/tickets/doCreateTicket":"/tickets/doUpdateTicket",e.currentTarget,function(e){e.success?(cityssm.disableNavBlocker(),!1,s.innerHTML='<span class="tag is-light is-success is-medium"><span class="icon"><i class="fas fa-check" aria-hidden="true"></i></span> <span>Saved Successfully</span></div>'):(a(),cityssm.alertModal("Ticket Not Saved",e.message,"OK","danger")),e.success&&t&&cityssm.openHtmlModal("ticket-createSuccess",{onshow:function(){document.getElementById("createSuccess--ticketNumber").innerText=n,document.getElementById("createSuccess--editTicketButton").setAttribute("href","/tickets/"+e.ticketID+"/edit"),document.getElementById("createSuccess--newTicketButton").setAttribute("href","/tickets/new/"+e.nextTicketNumber)}})})}),t||document.getElementById("is-delete-ticket-button").addEventListener("click",function(t){t.preventDefault(),cityssm.confirmModal("Delete Ticket?","Are you sure you want to delete this ticket record?","Yes, Delete Ticket","danger",function(){cityssm.postJSON("/tickets/doDeleteTicket",{ticketID:e},function(e){e.success&&(window.location.href="/tickets")})})}),pts.getDefaultConfigProperty("locationClasses",function(e){for(var t,s={},a=[],n=0;n<e.length;n+=1){var i=e[n];s[i.locationClassKey]=i}var l=function(e){e.preventDefault(),document.getElementById("ticket--locationKey").value="",document.getElementById("ticket--locationName").value="",t(),a=[]},d=function(e){e.preventDefault();var s=a[parseInt(e.currentTarget.getAttribute("data-index"),10)];document.getElementById("ticket--locationKey").value=s.locationKey,document.getElementById("ticket--locationName").value=s.locationName,t(),a=[]},c=function(e){e.preventDefault(),cityssm.openHtmlModal("ticket-setLocation",{onshown:function(e,n){t=n,cityssm.postJSON("/offences/doGetAllLocations",{},function(e){a=e;var t=document.createElement("div");t.className="panel mb-4";for(var n=0;n<a.length;n+=1){var i=a[n],l=s[i.locationClassKey],c=document.createElement("a");c.className="panel-block is-block",c.setAttribute("data-index",n.toString()),c.setAttribute("href","#"),c.addEventListener("click",d),c.innerHTML='<div class="level"><div class="level-left">'+cityssm.escapeHTML(i.locationName)+"</div>"+(l?'<div class="level-right"><span class="tag is-primary">'+cityssm.escapeHTML(l.locationClass)+"</span></div>":"")+"</div>",t.insertAdjacentElement("beforeend",c)}var o=document.getElementById("container--parkingLocations");cityssm.clearElement(o),o.insertAdjacentElement("beforeend",t)}),document.getElementById("is-clear-location-button").addEventListener("click",l)},onremoved:function(){document.getElementById("is-location-lookup-button").focus()}})};document.getElementById("is-location-lookup-button").addEventListener("click",c),document.getElementById("ticket--locationName").addEventListener("dblclick",c)});var l,d=[],c=[],o=function(e){e.preventDefault(),document.getElementById("ticket--bylawNumber").value="";var t=document.getElementById("ticket--offenceAmount");t.classList.add("is-readonly"),t.setAttribute("readonly","readonly"),t.closest(".field").getElementsByClassName("is-unlock-field-button")[0].removeAttribute("disabled"),t.value="";var s=document.getElementById("ticket--discountOffenceAmount");s.classList.add("is-readonly"),s.setAttribute("readonly","readonly"),s.closest(".field").getElementsByClassName("is-unlock-field-button")[0].removeAttribute("disabled"),s.value="";var a=document.getElementById("ticket--discountDays");a.classList.add("is-readonly"),a.setAttribute("readonly","readonly"),a.closest(".field").getElementsByClassName("is-unlock-field-button")[0].removeAttribute("disabled"),a.value="",document.getElementById("ticket--parkingOffence").value="",l(),d=[]},r=function(e){e.preventDefault();var t=d[parseInt(e.currentTarget.getAttribute("data-index"),10)];document.getElementById("ticket--bylawNumber").value=t.bylawNumber;var s=document.getElementById("ticket--offenceAmount");s.classList.add("is-readonly"),s.setAttribute("readonly","readonly"),s.closest(".field").getElementsByClassName("is-unlock-field-button")[0].removeAttribute("disabled"),s.value=t.offenceAmount.toFixed(2);var a=document.getElementById("ticket--discountOffenceAmount");a.classList.add("is-readonly"),a.setAttribute("readonly","readonly"),a.closest(".field").getElementsByClassName("is-unlock-field-button")[0].removeAttribute("disabled"),a.value=t.discountOffenceAmount.toFixed(2);var n=document.getElementById("ticket--discountDays");n.classList.add("is-readonly"),n.setAttribute("readonly","readonly"),n.closest(".field").getElementsByClassName("is-unlock-field-button")[0].removeAttribute("disabled"),n.value=t.discountDays.toString(),document.getElementById("ticket--parkingOffence").value=t.bylawDescription,l(),d=[]},u=function(e){for(var t=e.currentTarget.value.trim().toLowerCase().split(" "),s=0;s<d.length;s+=1){for(var a=!0,n=d[s],i=0;i<t.length;i+=1){var l=t[i];if(-1===n.bylawNumber.toLowerCase().indexOf(l)&&-1===n.bylawDescription.toLowerCase().indexOf(l)){a=!1;break}}a?c[s].classList.remove("is-hidden"):c[s].classList.add("is-hidden")}},m=function(e){e.preventDefault(),cityssm.openHtmlModal("ticket-setBylawOffence",{onshown:function(e,t){var s;l=t,s=document.getElementById("ticket--locationKey").value,cityssm.postJSON("/offences/doGetOffencesByLocation",{locationKey:s},function(e){d=e;var t=document.createElement("div");t.className="panel mb-4";for(var s=0;s<d.length;s+=1){var a=d[s],n=document.createElement("a");n.className="panel-block is-block",n.setAttribute("data-index",s.toString()),n.setAttribute("href","#"),n.addEventListener("click",r),n.innerHTML='<div class="columns"><div class="column"><span class="has-text-weight-semibold">'+cityssm.escapeHTML(a.bylawNumber)+"</span><br /><small>"+cityssm.escapeHTML(a.bylawDescription)+'</small></div><div class="column is-narrow has-text-weight-semibold">$'+a.offenceAmount.toFixed(2)+"</div></div>",t.insertAdjacentElement("beforeend",n),c.push(n)}var i=document.getElementById("container--bylawNumbers");cityssm.clearElement(i),i.appendChild(t)});var a=document.getElementById("bylawLookup--searchStr");a.focus(),a.addEventListener("keyup",u),document.getElementById("is-clear-bylaw-button").addEventListener("click",o)},onremoved:function(){document.getElementById("is-bylaw-lookup-button").focus()}})};document.getElementById("is-bylaw-lookup-button").addEventListener("click",m),document.getElementById("ticket--bylawNumber").addEventListener("dblclick",m);var v=document.getElementById("ticket--licencePlateIsMissing");v.addEventListener("change",function(){v.checked?(document.getElementById("ticket--licencePlateCountry").removeAttribute("required"),document.getElementById("ticket--licencePlateProvince").removeAttribute("required"),document.getElementById("ticket--licencePlateNumber").removeAttribute("required")):(document.getElementById("ticket--licencePlateCountry").setAttribute("required","required"),document.getElementById("ticket--licencePlateProvince").setAttribute("required","required"),document.getElementById("ticket--licencePlateNumber").setAttribute("required","required"))});var f=function(){var e=document.getElementById("datalist--licencePlateProvince");cityssm.clearElement(e);var t=pts.getLicencePlateCountryProperties(document.getElementById("ticket--licencePlateCountry").value);if(t&&t.provinces)for(var s=Object.values(t.provinces),a=0;a<s.length;a+=1){var n=document.createElement("option");n.setAttribute("value",s[a].provinceShortName),e.appendChild(n)}};document.getElementById("ticket--licencePlateCountry").addEventListener("change",f),pts.loadDefaultConfigProperties(f);var g=function(e){for(var t=e.getElementsByClassName("panel-block");t.length>0;)t[0].remove()};if(!t){var y=document.getElementById("is-remark-panel"),k=exports.ticketRemarks;delete exports.ticketRemarks;var p=function(t){var s=t.currentTarget.getAttribute("data-remark-index");cityssm.confirmModal("Delete Remark?","Are you sure you want to delete this remark?","Yes, Delete","warning",function(){cityssm.postJSON("/tickets/doDeleteRemark",{ticketID:e,remarkIndex:s},function(e){e.success&&h()})})},b=function(t){var s;t.preventDefault();var a=parseInt(t.currentTarget.getAttribute("data-index"),10),n=k[a],i=function(e){e.preventDefault(),cityssm.postJSON("/tickets/doUpdateRemark",e.currentTarget,function(e){e.success&&(s(),h())})};cityssm.openHtmlModal("ticket-editRemark",{onshow:function(t){document.getElementById("editRemark--ticketID").value=e,document.getElementById("editRemark--remarkIndex").value=n.remarkIndex,document.getElementById("editRemark--remark").value=n.remark,document.getElementById("editRemark--remarkDateString").value=n.remarkDateString,document.getElementById("editRemark--remarkTimeString").value=n.remarkTimeString,t.getElementsByTagName("form")[0].addEventListener("submit",i)},onshown:function(e,t){s=t}})},E=function(){if(g(y),0!==k.length)for(var e=0;e<k.length;e+=1){var t=k[e],s=document.createElement("div");s.className="panel-block is-block",s.innerHTML='<div class="columns"><div class="column"><p class="has-newline-chars">'+cityssm.escapeHTML(t.remark)+'</p><p class="is-size-7">'+(t.recordCreate_timeMillis===t.recordUpdate_timeMillis?"":'<i class="fas fa-pencil-alt" aria-hidden="true"></i> ')+t.recordUpdate_userName+" - "+t.remarkDateString+" "+t.remarkTimeString+"</p></div>"+(t.canUpdate?'<div class="column is-narrow"><div class="buttons is-right has-addons"><button class="button is-small is-edit-remark-button" data-tooltip="Edit Remark" data-index="'+e+'" type="button"><span class="icon is-small"><i class="fas fa-pencil-alt" aria-hidden="true"></i></span> <span>Edit</span></button><button class="button is-small has-text-danger is-delete-remark-button" data-tooltip="Delete Remark" data-remark-index="'+t.remarkIndex+'" type="button"><i class="fas fa-trash" aria-hidden="true"></i><span class="sr-only">Delete</span></button></div></div>':"")+"</div>",t.canUpdate&&(s.getElementsByClassName("is-edit-remark-button")[0].addEventListener("click",b),s.getElementsByClassName("is-delete-remark-button")[0].addEventListener("click",p)),y.appendChild(s)}else y.insertAdjacentHTML("beforeend",'<div class="panel-block is-block"><div class="message is-info"><p class="message-body">There are no remarks associated with this ticket.</p></div></div>')},h=function(){g(y),y.insertAdjacentHTML("beforeend",'<div class="panel-block is-block"><p class="has-text-centered has-text-grey-lighter"><i class="fas fa-2x fa-circle-notch fa-spin" aria-hidden="true"></i><br /><em>Loading remarks...</p></div>'),cityssm.postJSON("/tickets/doGetRemarks",{ticketID:e},function(e){k=e,E()})};document.getElementById("is-add-remark-button").addEventListener("click",function(t){var s;t.preventDefault();var a=function(e){e.preventDefault(),cityssm.postJSON("/tickets/doAddRemark",e.currentTarget,function(e){e.success&&(s(),h())})};cityssm.openHtmlModal("ticket-addRemark",{onshow:function(t){document.getElementById("addRemark--ticketID").value=e,t.getElementsByTagName("form")[0].addEventListener("submit",a)},onshown:function(e,t){s=t}})}),E()}if(!t){var B=document.getElementById("is-status-panel"),I=exports.ticketStatusLog;delete exports.ticketStatusLog;var L=function(t){t.preventDefault(),cityssm.confirmModal("Mark Ticket as Resolved?","Once resolved, you will no longer be able to make changes to the ticket.","Yes, Resolve Ticket","info",function(){cityssm.postJSON("/tickets/doResolveTicket",{ticketID:e},function(t){t.success&&(window.location.href="/tickets/"+e)})})},T=function(t){var s=t.currentTarget.getAttribute("data-status-index");cityssm.confirmModal("Delete Remark?","Are you sure you want to delete this status?","Yes, Delete","warning",function(){cityssm.postJSON("/tickets/doDeleteStatus",{ticketID:e,statusIndex:s},function(e){e.success&&D()})})},S=function(t){var s;t.preventDefault();var a=parseInt(t.currentTarget.getAttribute("data-index"),10),n=I[a],i=function(e){e.preventDefault(),cityssm.postJSON("/tickets/doUpdateStatus",e.currentTarget,function(e){e.success&&(s(),D())})},l=function(e){var t=pts.getTicketStatus(e.currentTarget.value),s=document.getElementById("editStatus--statusField");(s.value="",t&&t.statusField)?((a=s.closest(".field")).getElementsByTagName("label")[0].innerText=t.statusField.fieldLabel,a.classList.remove("is-hidden")):s.closest(".field").classList.add("is-hidden");var a,n=document.getElementById("editStatus--statusField2");(n.value="",t&&t.statusField2)?((a=n.closest(".field")).getElementsByTagName("label")[0].innerText=t.statusField2.fieldLabel,a.classList.remove("is-hidden")):s.closest(".field").classList.add("is-hidden")};cityssm.openHtmlModal("ticket-editStatus",{onshow:function(t){document.getElementById("editStatus--ticketID").value=e,document.getElementById("editStatus--statusIndex").value=n.statusIndex,document.getElementById("editStatus--statusField").value=n.statusField,document.getElementById("editStatus--statusField2").value=n.statusField2,document.getElementById("editStatus--statusNote").value=n.statusNote;var s=document.getElementById("editStatus--statusDateString");s.value=n.statusDateString,s.setAttribute("max",cityssm.dateToString(new Date)),document.getElementById("editStatus--statusTimeString").value=n.statusTimeString,pts.getDefaultConfigProperty("parkingTicketStatuses",function(e){for(var t=!1,s=document.getElementById("editStatus--statusKey"),a=0;a<e.length;a+=1){var i=e[a];if((i.isUserSettable||i.statusKey===n.statusKey)&&(s.insertAdjacentHTML("beforeend",'<option value="'+i.statusKey+'">'+i.status+"</option>"),i.statusKey===n.statusKey)){var d;if(t=!0,i.statusField)(d=document.getElementById("editStatus--statusField").closest(".field")).getElementsByTagName("label")[0].innerText=i.statusField.fieldLabel,d.classList.remove("is-hidden");if(i.statusField2)(d=document.getElementById("editStatus--statusField2").closest(".field")).getElementsByTagName("label")[0].innerText=i.statusField2.fieldLabel,d.classList.remove("is-hidden")}}t||s.insertAdjacentHTML("beforeend",'<option value="'+n.statusKey+'">'+n.statusKey+"</option>"),s.value=n.statusKey,s.addEventListener("change",l)}),t.getElementsByTagName("form")[0].addEventListener("submit",i)},onshown:function(e,t){s=t}})},N=function(){if(g(B),0!==I.length)for(var e=0;e<I.length;e+=1){var t=I[e],s=pts.getTicketStatus(t.statusKey);if(0===e&&s&&s.isFinalStatus){var a=document.createElement("div");a.className="panel-block is-block",a.innerHTML='<div class="message is-info is-clearfix"><div class="message-body"><div class="columns"><div class="column"><strong>This ticket is able to be marked as resolved.</strong></div><div class="column is-narrow has-text-right align-self-flex-end"><button class="button is-info" type="button"><span class="icon is-small"><i class="fas fa-check" aria-hidden="true"></i></span><span>Resolve Ticket</span></button></div></div></div></div>',a.getElementsByTagName("button")[0].addEventListener("click",L),B.appendChild(a)}var n=document.createElement("div");n.className="panel-block is-block",n.innerHTML='<div class="columns"><div class="column"><div class="level mb-1"><div class="level-left"><strong>'+(s?s.status:t.statusKey)+'</strong></div><div class="level-right">'+t.statusDateString+"</div></div>"+(t.statusField&&""!==t.statusField?'<p class="is-size-7"><strong>'+(s&&s.statusField?s.statusField.fieldLabel:"")+":</strong> "+t.statusField+"</p>":"")+(t.statusField2&&""!==t.statusField2?'<p class="is-size-7"><strong>'+(s&&s.statusField2?s.statusField2.fieldLabel:"")+":</strong> "+t.statusField2+"</p>":"")+'<p class="has-newline-chars is-size-7">'+t.statusNote+"</p></div>"+(t.canUpdate&&0===e?'<div class="column is-narrow"><div class="buttons is-right has-addons"><button class="button is-small is-edit-status-button" data-tooltip="Edit Status" data-index="'+e+'" type="button"><span class="icon is-small"><i class="fas fa-pencil-alt" aria-hidden="true"></i></span> <span>Edit</span></button><button class="button is-small has-text-danger is-delete-status-button" data-tooltip="Delete Status" data-status-index="'+t.statusIndex+'" type="button"><i class="fas fa-trash" aria-hidden="true"></i><span class="sr-only">Delete</span></button></div></div>':"")+"</div>",t.canUpdate&&0===e&&(n.getElementsByClassName("is-edit-status-button")[0].addEventListener("click",S),n.getElementsByClassName("is-delete-status-button")[0].addEventListener("click",T)),B.appendChild(n)}else B.insertAdjacentHTML("beforeend",'<div class="panel-block is-block"><div class="message is-info"><p class="message-body">There are no statuses associated with this ticket.</p></div></div>')},D=function(){g(B),B.insertAdjacentHTML("beforeend",'<div class="panel-block is-block"><p class="has-text-centered has-text-grey-lighter"><i class="fas fa-2x fa-circle-notch fa-spin" aria-hidden="true"></i><br /><em>Loading statuses...</p></div>'),cityssm.postJSON("/tickets/doGetStatuses",{ticketID:e},function(e){I=e,N()})};document.getElementById("is-add-status-button").addEventListener("click",function(t){var s;t.preventDefault();var a=function(t){t.preventDefault();var a=document.getElementById("addStatus--resolveTicket").checked;cityssm.postJSON("/tickets/doAddStatus",t.currentTarget,function(t){t.success&&(s(),a?window.location.href="/tickets/"+e:D())})},n=function(e){var t=pts.getTicketStatus(e.currentTarget.value),s=document.getElementById("addStatus--statusField");(s.value="",t&&t.statusField)?((a=s.closest(".field")).getElementsByTagName("label")[0].innerText=t.statusField.fieldLabel,a.classList.remove("is-hidden")):s.closest(".field").classList.add("is-hidden");var a,n=document.getElementById("addStatus--statusField2");(n.value="",t&&t.statusField2)?((a=n.closest(".field")).getElementsByTagName("label")[0].innerText=t.statusField2.fieldLabel,a.classList.remove("is-hidden")):n.closest(".field").classList.add("is-hidden");var i=document.getElementById("addStatus--resolveTicket");i.checked=!1,t&&t.isFinalStatus?i.closest(".field").classList.remove("is-hidden"):i.closest(".field").classList.add("is-hidden")};cityssm.openHtmlModal("ticket-addStatus",{onshow:function(t){document.getElementById("addStatus--ticketID").value=e,pts.getDefaultConfigProperty("parkingTicketStatuses",function(e){for(var t=document.getElementById("addStatus--statusKey"),s=0;s<e.length;s+=1){var a=e[s];a.isUserSettable&&t.insertAdjacentHTML("beforeend",'<option value="'+a.statusKey+'">'+a.status+"</option>")}t.addEventListener("change",n)}),t.getElementsByTagName("form")[0].addEventListener("submit",a)},onshown:function(e,t){s=t}})}),document.getElementById("is-add-paid-status-button").addEventListener("click",function(t){var s;t.preventDefault();var a=function(t){t.preventDefault();var a=document.getElementById("addPaidStatus--resolveTicket").checked;cityssm.postJSON("/tickets/doAddStatus",t.currentTarget,function(t){t.success&&(s(),a?window.location.href="/tickets/"+e:D())})};cityssm.openHtmlModal("ticket-addStatusPaid",{onshow:function(t){document.getElementById("addPaidStatus--ticketID").value=e;var s=document.getElementById("addPaidStatus--statusField"),n=document.getElementById("ticket--offenceAmount").value,i=document.getElementById("ticket--issueDateString").value,l=document.getElementById("ticket--discountDays").value;if(""===i||""===l)s.value=n;else{var d=cityssm.dateToString(new Date);cityssm.dateStringDifferenceInDays(i,d)<=parseInt(l,10)?s.value=document.getElementById("ticket--discountOffenceAmount").value:s.value=n}t.getElementsByTagName("form")[0].addEventListener("submit",a)},onshown:function(e,t){s=t}})}),pts.loadDefaultConfigProperties(N)}for(var A=function(e){e.preventDefault();var t=e.currentTarget,s=t.getAttribute("data-unlock"),a=t.closest(".field").getElementsByTagName(s)[0];a.removeAttribute("readonly"),a.classList.remove("is-readonly"),a.focus(),t.setAttribute("disabled","disabled")},w=document.getElementsByClassName("is-unlock-field-button"),x=0;x<w.length;x+=1)w[x].addEventListener("click",A)}();