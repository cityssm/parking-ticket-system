"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),(()=>{var t;const e="true"===document.querySelectorAll("main")[0].dataset.canUpdate;let s=exports.currentBatch;delete exports.currentBatch;let a=exports.convictableTickets;delete exports.convictableTickets;const n=document.querySelector("#filter--parkingTicket"),c=document.querySelector("#convictable-tickets-container");let i=[];function o(t){var e;t.preventDefault();const n=t.currentTarget;n.setAttribute("disabled","disabled");const c=Number.parseInt(null!==(e=n.dataset.index)&&void 0!==e?e:"-1",10),i=a[c].ticketID;cityssm.postJSON("/tickets/doAddTicketToConvictionBatch",{batchID:s.batchID,ticketID:i},t=>{t.success?(s=t.batch,k(),a.splice(c,1),l()):(n.removeAttribute("disabled"),cityssm.alertModal("Ticket Not Added",t.message,"OK","danger"))})}function r(t){let e;t.preventDefault();cityssm.openHtmlModal("loading",{onshow(){document.querySelector("#is-loading-modal-message").textContent="Adding "+i.length.toString()+" ticket"+(1===i.length?"":"s")+"..."},onshown(t,n){e=n,cityssm.postJSON("/tickets-ontario/doAddAllTicketsToConvictionBatch",{batchID:s.batchID,ticketIDs:i},t=>{e(),t.batch&&(s=t.batch,k()),t.tickets&&(a=t.tickets,l()),0===t.successCount&&cityssm.alertModal("Results",t.message?t.message:"No tickets were added to the batch.","OK","warning")})}})}function l(){var t,l;if(cityssm.clearElement(c),i=[],!s)return void(c.innerHTML='<div class="message is-warning">\n        <div class="message-body">Select a target batch to get started.</div>\n        </div>');if(!e)return void(c.innerHTML='<div class="message is-warning">\n        <div class="message-body">Parking tickets can only be added by users with update permissions.</div>\n        </div>');if(s.lockDate)return void(c.innerHTML='<div class="message is-warning">\n        <div class="message-body">The target batch is locked and cannot accept additional tickets.</div>\n        </div>');if(0===a.length)return void(c.innerHTML='<div class="message is-info">\n        <div class="message-body">There are no parking tickets currently eligible for conviction.</div>\n        </div>');const d=n.value.trim().toLowerCase(),h=document.createElement("tbody");for(const[e,s]of a.entries()){if(!s.ticketNumber.toLowerCase().includes(d)&&!s.licencePlateNumber.toLowerCase().includes(d))continue;i.push(s.ticketID);const a=document.createElement("tr");a.innerHTML='<td><a data-tooltip="View Ticket (Opens in New Window)" href="/tickets/'+s.ticketID.toString()+'" target="_blank">'+cityssm.escapeHTML(s.ticketNumber)+"</a></td><td>"+s.issueDateString+'</td><td><span class="licence-plate-number is-size-6">'+cityssm.escapeHTML(s.licencePlateNumber)+'</span><br /><span class="has-tooltip-right is-size-7" data-tooltip="Primary Owner">'+cityssm.escapeHTML(null!==(t=s.licencePlateOwner_ownerName1)&&void 0!==t?t:"")+'</span></td><td class="has-text-right"><button class="button is-small" data-index="'+e.toString()+'" type="button"><span class="icon is-small"><i class="fas fa-plus" aria-hidden="true"></i></span><span>Add</span></button></td>',null===(l=a.querySelector("button"))||void 0===l||l.addEventListener("click",o),h.append(a)}if(0===i.length)return void(c.innerHTML='<div class="message is-info">\n        <div class="message-body">There are no parking tickets that meet the search criteria.</div>\n        </div>');const u=document.createElement("button");u.className="button is-fullwidth mb-3",u.innerHTML='<span class="icon is-small"><i class="fas fa-plus" aria-hidden="true"></i></span><span>Add '+i.length.toString()+" Parking Ticket"+(1===i.length?"":"s")+"</span>",u.addEventListener("click",r),c.append(u);const m=document.createElement("table");m.className="table is-striped is-hoverable is-fullwidth",m.innerHTML="<thead><tr><th>Ticket Number</th><th>Issue Date</th><th>Licence Plate</th><th></th></tr></thead>",m.append(h),c.append(m)}n.addEventListener("keyup",l);const d=document.querySelector("#batch-entries-container"),h=t=>{var e;t.preventDefault();const n=t.currentTarget;n.setAttribute("disabled","disabled");const c=Number.parseInt(null!==(e=n.dataset.index)&&void 0!==e?e:"-1",10),i=s.batchEntries[c].ticketID;cityssm.postJSON("/tickets-ontario/doRemoveTicketFromConvictionBatch",{batchID:s.batchID,ticketID:i},t=>{t.success?(s.batchEntries.splice(c,1),k(),a=t.tickets,l()):n.removeAttribute("disabled")})},u=t=>{t.preventDefault();cityssm.confirmModal("Clear Batch","Are you sure you want to remove all the parking tickets from the batch?","Yes, Clear the Batch","warning",()=>{cityssm.postJSON("/tickets-ontario/doClearConvictionBatch",{batchID:s.batchID},t=>{t.success||cityssm.alertModal("Batch Not Cleared",t.message,"OK","danger"),t.batch&&(s=t.batch,k()),t.tickets&&(a=t.tickets,l())})})},m=t=>{t.preventDefault();cityssm.confirmModal("Lock Batch?","<strong>Are you sure you want to lock this batch?</strong><br />Once locked, no further changes to the batch will be allowed. The option to download the batch will become available.","Yes, Lock the Batch","warning",()=>{cityssm.postJSON("/tickets/doLockConvictionBatch",{batchID:s.batchID},t=>{t.success&&(s.lockDate=t.lockDate,s.lockDateString=t.lockDateString,k(),l())})})},b=t=>{t.preventDefault();cityssm.confirmModal("Lock Batch?","<strong>Are you sure you want to unlock this batch?</strong><br />Once unlocked, changes to the batch will be allowed.","Yes, Unlock the Batch","warning",()=>{cityssm.postJSON("/tickets/doUnlockConvictionBatch",{batchID:s.batchID},t=>{t.success&&(s.lockDate=void 0,s.lockDateString=void 0,k(),l())})})},p=t=>{t.preventDefault();const e=()=>{window.open("/tickets/convict/"+s.batchID.toString()+"/print")};s.sentDate?e():cityssm.confirmModal("Download Batch","<strong>You are about to download the batch for the first time.</strong><br />Once downloaded, the date will be tracked, and the batch will no longer be able to be unlocked.","Yes, Download the Batch","warning",()=>{cityssm.postJSON("/tickets/doMarkConvictionBatchSent",{batchID:s.batchID},t=>{s=t.batch,k()}),e()})},k=()=>{if(document.querySelector("#batchSelector--batchID").textContent="Batch #"+s.batchID.toString(),document.querySelector("#batchSelector--batchDetails").innerHTML='<span class="has-tooltip-left" data-tooltip="Batch Date"><span class="icon"><i class="fas fa-star" aria-hidden="true"></i></span> '+s.batchDateString+"</span>"+(s.lockDate?'<br /><span class="has-tooltip-left" data-tooltip="Lock Date"><span class="icon"><i class="fas fa-lock" aria-hidden="true"></i></span> '+s.lockDateString+"</span>":""),cityssm.clearElement(d),0===s.batchEntries.length)return void(d.innerHTML='<div class="message is-info"><div class="message-body">There are no parking tickets in this batch.</div></div>');const t=document.createElement("tbody"),a=e&&!s.lockDate;for(const[e,n]of s.batchEntries.entries()){const s=document.createElement("tr");s.innerHTML='<td><a href="/tickets/'+n.ticketID.toString()+'" target="_blank">'+n.ticketNumber+"</a></td><td>"+n.issueDateString+'</td><td><span class="licence-plate-number is-size-6">'+cityssm.escapeHTML(n.licencePlateNumber)+"</span></td>"+(a?'<td class="has-text-right"><button class="button is-small" data-index="'+e.toString()+'" type="button"><span class="icon is-small"><i class="fas fa-minus" aria-hidden="true"></i></span><span>Remove</span></button></td>':""),a&&s.querySelector("button").addEventListener("click",h),t.append(s)}const n=document.createElement("table");if(n.className="table is-fullwidth is-striped is-hoverable",n.innerHTML=`<thead><tr>\n      <th>Ticket Number</th>\n      <th>Issue Date</th>\n      <th>Licence Plate</th>\n      ${a?"<th></th>":""}\n      </tr></thead>`,n.append(t),d.append(n),e&&!s.lockDate){const t=document.createElement("button");t.className="button is-fullwidth mb-3",t.innerHTML='<span class="icon is-small">\n        <i class="fas fa-lock" aria-hidden="true"></i>\n        </span>\n        <span>Lock Batch</span>',t.addEventListener("click",m),d.prepend(t);const e=document.createElement("button");e.className="button is-fullwidth mb-3",e.innerHTML='<span class="icon is-small">\n        <i class="fas fa-broom" aria-hidden="true"></i>\n        </span>\n        <span>Clear Batch</span>',e.addEventListener("click",u),n.before(e)}if(e&&s.lockDate&&!s.sentDate){const t=document.createElement("button");t.className="button is-fullwidth mb-3",t.innerHTML='<span class="icon is-small"><i class="fas fa-unlock" aria-hidden="true"></i></span><span>Unlock Batch</span>',t.addEventListener("click",b),d.prepend(t)}if(s.lockDate){const t=document.createElement("button");t.className="button is-fullwidth mb-3",t.innerHTML='<span class="icon is-small">\n        <i class="fas fa-download" aria-hidden="true"></i>\n        </span>\n        <span>Download Report for Provincial Offences</span>',t.addEventListener("click",p),n.before(t)}};null===(t=document.querySelector("#is-select-batch-button"))||void 0===t||t.addEventListener("click",t=>{let a;t.preventDefault();const n=t=>{t.preventDefault();const e=t.currentTarget.dataset.batchId;cityssm.postJSON("/tickets/doGetConvictionBatch",{batchID:e},t=>{s=t,k(),l()}),a()};cityssm.openHtmlModal("mto-selectBatch",{onshow(t){if(e){const e=t.querySelector(".is-create-batch-button");e.classList.remove("is-hidden"),e.addEventListener("click",t=>{t.preventDefault(),a(),cityssm.confirmModal("Create a New Batch","Are you sure you want to create a new conviction batch?","Yes, Create Batch","info",()=>{cityssm.postJSON("/tickets/doCreateConvictionBatch",{},t=>{t.success&&(s=t.batch,k(),l())})})})}cityssm.postJSON("/tickets/doGetRecentConvictionBatches",[],e=>{const s=t.querySelector(".is-results-container");if(cityssm.clearElement(s),0===e.length)return s.className="message is-info",void(s.innerHTML='<div class="message-body">There are no recent conviction batches.</div>');s.className="list is-hoverable";for(const t of e){const e=document.createElement("a");e.className="list-item",e.dataset.batchId=t.batchID.toString(),e.href="#",e.innerHTML='<div class="columns"><div class="column is-narrow">#'+t.batchID.toString()+'</div><div class="column has-text-right">'+t.batchDateString+(t.lockDate?'<br /><div class="tags justify-flex-end"><span class="tag"><span class="icon is-small"><i class="fas fa-lock" aria-hidden="true"></i></span><span>Locked</span></span>':"")+"</div></div>",e.addEventListener("click",n),s.append(e)}})},onshown(t,e){a=e}})}),s&&k(),l()})();