"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),(()=>{const t=cityssm.escapeHTML(document.querySelector("#ticket--ticketID").value),e=document.querySelector("#is-status-panel");let s=exports.ticketStatusLog;delete exports.ticketStatusLog;const a=()=>{const t=e.querySelectorAll(".panel-block");for(const e of t)e.remove()},i=e=>{e.preventDefault(),cityssm.confirmModal("Mark Ticket as Resolved?","Once resolved, you will no longer be able to make changes to the ticket.","Yes, Resolve Ticket","info",()=>{cityssm.postJSON("/tickets/doResolveTicket",{ticketID:t},e=>{e.success&&(window.location.href="/tickets/"+t)})})},l=e=>{const s=e.currentTarget.dataset.statusIndex;cityssm.confirmModal("Delete Remark?","Are you sure you want to delete this status?","Yes, Delete","warning",()=>{cityssm.postJSON("/tickets/doDeleteStatus",{ticketID:t,statusIndex:s},t=>{t.success&&c()})})},o=e=>{let a;e.preventDefault();const i=Number.parseInt(e.currentTarget.dataset.index,10),l=s[i],o=t=>{t.preventDefault(),cityssm.postJSON("/tickets/doUpdateStatus",t.currentTarget,t=>{t.success&&(a(),c())})},d=t=>{const e=pts.getTicketStatus(t.currentTarget.value),s=document.querySelector("#editStatus--statusField");if(s.value="",null==e?void 0:e.statusField){const t=s.closest(".field");t.querySelector("label").textContent=e.statusField.fieldLabel,t.classList.remove("is-hidden")}else s.closest(".field").classList.add("is-hidden");const a=document.querySelector("#editStatus--statusField2");if(a.value="",null==e?void 0:e.statusField2){const t=a.closest(".field");t.querySelector("label").textContent=e.statusField2.fieldLabel,t.classList.remove("is-hidden")}else s.closest(".field").classList.add("is-hidden")};cityssm.openHtmlModal("ticket-editStatus",{onshow(e){document.querySelector("#editStatus--ticketID").value=t,document.querySelector("#editStatus--statusIndex").value=l.statusIndex.toString(),document.querySelector("#editStatus--statusField").value=l.statusField,document.querySelector("#editStatus--statusField2").value=l.statusField2,document.querySelector("#editStatus--statusNote").value=l.statusNote;const s=document.querySelector("#editStatus--statusDateString");s.value=l.statusDateString,s.setAttribute("max",cityssm.dateToString(new Date)),document.querySelector("#editStatus--statusTimeString").value=l.statusTimeString,pts.getDefaultConfigProperty("parkingTicketStatuses",t=>{let e=!1;const s=document.querySelector("#editStatus--statusKey");for(const a of t)if((a.isUserSettable||a.statusKey===l.statusKey)&&(s.insertAdjacentHTML("beforeend",'<option value="'+a.statusKey+'">'+a.status+"</option>"),a.statusKey===l.statusKey)){if(e=!0,a.statusField){const t=document.querySelector("#editStatus--statusField").closest(".field");t.querySelector("label").textContent=a.statusField.fieldLabel,t.classList.remove("is-hidden")}if(a.statusField2){const t=document.querySelector("#editStatus--statusField2").closest(".field");t.querySelector("label").textContent=a.statusField2.fieldLabel,t.classList.remove("is-hidden")}}e||s.insertAdjacentHTML("beforeend",'<option value="'+l.statusKey+'">'+l.statusKey+"</option>"),s.value=l.statusKey,s.addEventListener("change",d)}),e.querySelector("form").addEventListener("submit",o)},onshown(t,e){a=e}})},d=()=>{if(a(),0===s.length)return void e.insertAdjacentHTML("beforeend",'<div class="panel-block is-block"><div class="message is-info"><p class="message-body">There are no statuses associated with this ticket.</p></div></div>');for(const t of s){const s=pts.getTicketStatus(t.statusKey),a=document.createElement("div");a.className="panel-block is-block",a.innerHTML='<div class="columns"><div class="column"><div class="level mb-1"><div class="level-left"><strong>'+(s?s.status:t.statusKey)+'</strong></div><div class="level-right">'+t.statusDateString+"</div></div>"+(t.statusField&&""!==t.statusField?'<p class="is-size-7"><strong>'+((null==s?void 0:s.statusField)?s.statusField.fieldLabel:"")+":</strong> "+t.statusField+"</p>":"")+(t.statusField2&&""!==t.statusField2?'<p class="is-size-7"><strong>'+((null==s?void 0:s.statusField2)?s.statusField2.fieldLabel:"")+":</strong> "+t.statusField2+"</p>":"")+'<p class="has-newline-chars is-size-7">'+t.statusNote+"</p></div></div>",e.append(a)}const t=s[0];if(t.canUpdate){const s=e.querySelector(".panel-block").querySelector(".columns");s.insertAdjacentHTML("beforeend",'<div class="column is-narrow"><div class="buttons is-right has-addons"><button class="button is-small is-edit-status-button" data-tooltip="Edit Status" data-index="0" type="button"><span class="icon is-small"><i class="fas fa-pencil-alt" aria-hidden="true"></i></span> <span>Edit</span></button><button class="button is-small has-text-danger is-delete-status-button" data-tooltip="Delete Status" data-status-index="'+t.statusIndex.toString()+'" type="button"><i class="fas fa-trash" aria-hidden="true"></i><span class="sr-only">Delete</span></button></div></div>'),s.querySelector(".is-edit-status-button").addEventListener("click",o),s.querySelector(".is-delete-status-button").addEventListener("click",l)}const d=pts.getTicketStatus(t.statusKey);if(null==d?void 0:d.isFinalStatus){const t=document.createElement("div");t.className="panel-block is-block",t.innerHTML='<div class="message is-info is-clearfix"><div class="message-body"><div class="columns"><div class="column"><strong>This ticket is able to be marked as resolved.</strong></div><div class="column is-narrow has-text-right align-self-flex-end"><button class="button is-info" data-cy="resolve" type="button"><span class="icon is-small"><i class="fas fa-check" aria-hidden="true"></i></span><span>Resolve Ticket</span></button></div></div></div></div>',t.querySelector("button").addEventListener("click",i),e.prepend(t)}},c=()=>{a(),e.insertAdjacentHTML("beforeend",'<div class="panel-block is-block"><p class="has-text-centered has-text-grey-lighter"><i class="fas fa-2x fa-circle-notch fa-spin" aria-hidden="true"></i><br /><em>Loading statuses...</p></div>'),cityssm.postJSON("/tickets/doGetStatuses",{ticketID:t},t=>{s=t,d()})};document.querySelector("#is-add-status-button").addEventListener("click",e=>{let s;e.preventDefault();const a=e=>{e.preventDefault();const a=document.querySelector("#addStatus--resolveTicket").checked;cityssm.postJSON("/tickets/doAddStatus",e.currentTarget,e=>{e.success&&(s(),a?window.location.href="/tickets/"+t:c())})},i=t=>{const e=pts.getTicketStatus(t.currentTarget.value),s=document.querySelector("#addStatus--statusField");if(s.value="",null==e?void 0:e.statusField){const t=s.closest(".field");t.querySelector("label").textContent=e.statusField.fieldLabel,t.classList.remove("is-hidden")}else s.closest(".field").classList.add("is-hidden");const a=document.querySelector("#addStatus--statusField2");if(a.value="",null==e?void 0:e.statusField2){const t=a.closest(".field");t.querySelector("label").textContent=e.statusField2.fieldLabel,t.classList.remove("is-hidden")}else a.closest(".field").classList.add("is-hidden");const i=document.querySelector("#addStatus--resolveTicket");i.checked=!1,(null==e?void 0:e.isFinalStatus)?i.closest(".field").classList.remove("is-hidden"):i.closest(".field").classList.add("is-hidden")};cityssm.openHtmlModal("ticket-addStatus",{onshow(e){document.querySelector("#addStatus--ticketID").value=t,pts.getDefaultConfigProperty("parkingTicketStatuses",t=>{const e=document.querySelector("#addStatus--statusKey");for(const s of t)s.isUserSettable&&e.insertAdjacentHTML("beforeend",'<option value="'+s.statusKey+'">'+s.status+"</option>");e.addEventListener("change",i)}),e.querySelector("form").addEventListener("submit",a)},onshown(t,e){s=e}})}),document.querySelector("#is-add-paid-status-button").addEventListener("click",e=>{let s;e.preventDefault();const a=e=>{e.preventDefault();const a=document.querySelector("#addPaidStatus--resolveTicket").checked;cityssm.postJSON("/tickets/doAddStatus",e.currentTarget,e=>{e.success&&(s(),a?window.location.href="/tickets/"+t:c())})};cityssm.openHtmlModal("ticket-addStatusPaid",{onshow(e){document.querySelector("#addPaidStatus--ticketID").value=t;const s=document.querySelector("#addPaidStatus--statusField"),i=document.querySelector("#ticket--offenceAmount").value,l=document.querySelector("#ticket--issueDateString").value,o=document.querySelector("#ticket--discountDays").value;if(""===l||""===o)s.value=i;else{const t=cityssm.dateToString(new Date),e=cityssm.dateStringDifferenceInDays(l,t);s.value=e<=Number.parseInt(o,10)?document.querySelector("#ticket--discountOffenceAmount").value:i}e.querySelector("form").addEventListener("submit",a)},onshown(t,e){s=e}})}),pts.loadDefaultConfigProperties(d)})();