"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),(()=>{const e="true"===document.getElementsByTagName("main")[0].getAttribute("data-can-update");let t=-1,a=!0,s=!1;const n=document.getElementById("available--issueDaysAgo"),i=document.getElementById("is-available-plates-container"),c=document.getElementById("available--licencePlateNumber");let l=[],o=[];const d=e=>{e.preventDefault();const a=e.currentTarget;a.setAttribute("disabled","disabled");const s=parseInt(a.getAttribute("data-index"),10),n=l[s],i=a.closest(".is-plate-container");cityssm.postJSON("/plates/doAddLicencePlateToLookupBatch",{batchID:t,licencePlateCountry:"CA",licencePlateProvince:"ON",licencePlateNumber:n.licencePlateNumber,ticketID:n.ticketIDMin},e=>{e.success?(i.remove(),l[s]=null,f(e.batch)):a.removeAttribute("disabled")})},r=e=>{e.preventDefault();const a=e.currentTarget;a.setAttribute("disabled","disabled");const s=parseInt(a.getAttribute("data-index"),10),n=o[s],i=a.closest(".is-entry-container");cityssm.postJSON("/plates/doRemoveLicencePlateFromLookupBatch",{batchID:t,licencePlateCountry:"CA",licencePlateProvince:"ON",licencePlateNumber:n.licencePlateNumber},e=>{e.success?(i.remove(),b()):a.removeAttribute("disabled")})},p=e=>{e.preventDefault();cityssm.confirmModal("Clear Batch?","Are you sure you want to remove all licence plates from the batch?","Yes, Clear the Batch","warning",()=>{cityssm.postJSON("/plates/doClearLookupBatch",{batchID:t},e=>{e.success&&(f(e.batch),b())})})},m=e=>{e.preventDefault();const a=()=>{window.open("/plates-ontario/mtoExport/"+t),s=!0};s?a():cityssm.confirmModal("Download Batch?","<strong>You are about to download this batch for the first time.</strong><br />The date of this download will be tracked as part of the batch record.","OK, Download the File","warning",a)},u=(e,t)=>e+'<a class="tag has-tooltip-bottom" data-tooltip="View Ticket (Opens in New Window)" href="/tickets/byTicketNumber/'+encodeURIComponent(t)+'" target="_blank">'+cityssm.escapeHTML(t)+"</a> ",h=()=>{cityssm.clearElement(i);const e=document.createElement("div");e.className="panel";const a=c.value.toLowerCase().trim().split(" ");let s=[];if(l.forEach((t,n)=>{if(!t)return;let i=!0;const c=t.licencePlateNumber.toLowerCase();for(const e of a)if(-1===c.indexOf(e)){i=!1;break}if(!i)return;s.push([t.licencePlateNumber,t.ticketIDMin]);const l=document.createElement("div");l.className="panel-block is-block is-plate-container",l.innerHTML='<div class="level is-marginless"><div class="level-left"><div class="licence-plate"><div class="licence-plate-number">'+cityssm.escapeHTML(t.licencePlateNumber)+'</div></div></div><div class="level-right"><button class="button is-small" data-index="'+n+'" data-tooltip="Add to Batch" type="button"><span class="icon is-small"><i class="fas fa-plus" aria-hidden="true"></i></span><span>Add</span></button></div></div><div class="level"><div class="level-left"><div class="tags">'+t.ticketNumbers.reduce(u,"")+'</div></div><div class="level-right is-size-7">'+t.issueDateMinString+(t.issueDateMin===t.issueDateMax?"":" to "+t.issueDateMaxString)+"</div></div>",l.getElementsByTagName("button")[0].addEventListener("click",d),e.appendChild(l)}),s.length>0){const a=document.createElement("button");a.className="button is-fullwidth mb-3",a.innerHTML='<span class="icon is-small"><i class="fas fa-plus" aria-hidden="true"></i></span><span>Add '+s.length+" Licence Plate"+(1===s.length?"":"s")+"</span>",a.addEventListener("click",()=>{cityssm.openHtmlModal("loading",{onshown(e,a){document.getElementById("is-loading-modal-message").innerText="Adding "+s.length+" Licence Plate"+(1===s.length?"":"s")+"...",cityssm.postJSON("/plates/doAddAllLicencePlatesToLookupBatch",{batchID:t,licencePlateCountry:"CA",licencePlateProvince:"ON",licencePlateNumbers:s},e=>{a(),e.success&&(f(e.batch),b())})}})}),i.appendChild(a),i.appendChild(e)}else i.innerHTML='<div class="message is-info"><div class="message-body">There are no licence plates that meet your search criteria.</div></div>'},b=()=>{a?i.innerHTML='<div class="message is-info"><div class="message-body">Licence Plates cannot be added to a locked batch.</div></div>':(i.innerHTML='<p class="has-text-centered has-text-grey-lighter"><i class="fas fa-3x fa-circle-notch fa-spin" aria-hidden="true"></i><br /><em>Loading licence plates...</p>',cityssm.postJSON("/plates-ontario/doGetPlatesAvailableForMTOLookup",{batchID:t,issueDaysAgo:n.value},e=>{l=e,h()}))};document.getElementById("is-more-available-filters-toggle").addEventListener("click",e=>{e.preventDefault(),document.getElementById("is-more-available-filters").classList.toggle("is-hidden")}),c.addEventListener("keyup",h),n.addEventListener("change",b);const v=document.getElementById("is-lock-batch-button"),g=document.getElementById("is-batch-entries-container"),f=n=>{if(t=n.batchID,o=n.batchEntries,a=!(null==n.lockDate),s=!(null==n.sentDate),e&&(a?v.setAttribute("disabled","disabled"):v.removeAttribute("disabled")),document.getElementById("batchSelector--batchID").innerText="Batch #"+n.batchID,document.getElementById("batchSelector--batchDetails").innerHTML='<span class="icon is-small"><i class="fas fa-calendar" aria-hidden="true"></i></span><span>'+n.batchDateString+"</span> "+(a?'<span class="tag is-light"><span class="icon is-small"><i class="fas fa-lock" aria-hidden="true"></i></span> <span>'+n.lockDateString+"</span></span>":""),cityssm.clearElement(g),0===o.length)return void(g.innerHTML='<div class="message is-info"><p class="message-body">There are no licence plates included in the batch.</p></div>');cityssm.clearElement(g);const i=document.createElement("div");if(i.className="panel",o.forEach((e,t)=>{const s=document.createElement("div");s.className="panel-block is-block is-entry-container",s.innerHTML='<div class="level"><div class="level-left"><div class="licence-plate"><div class="licence-plate-number">'+cityssm.escapeHTML(e.licencePlateNumber)+"</div></div></div>"+(a?"":'<div class="level-right"><button class="button is-small" data-index="'+t+'" type="button"><span class="icon is-small"><i class="fas fa-minus" aria-hidden="true"></i></span><span>Remove</span></button></div>')+"</div>",a||s.getElementsByTagName("button")[0].addEventListener("click",r),i.appendChild(s)}),a){const e=document.createElement("button");e.className="button is-fullwidth mb-3",e.innerHTML='<span class="icon is-small"><i class="fas fa-download" aria-hidden="true"></i></span><span>Download File for MTO</span>',e.addEventListener("click",m),g.appendChild(e),g.insertAdjacentHTML("beforeend",'<a class="button is-fullwidth mb-3" href="https://www.apps.rus.mto.gov.on.ca/edtW/login/login.jsp" target="_blank" rel="noreferrer"><span class="icon is-small"><i class="fas fa-building" aria-hidden="true"></i></span><span>MTO ARIS Login</span></a>')}else{const e=document.createElement("button");e.className="button is-fullwidth mb-3",e.innerHTML='<span class="icon is-small"><i class="fas fa-broom" aria-hidden="true"></i></span><span>Clear Batch</span>',e.addEventListener("click",p),g.appendChild(e)}g.appendChild(i)};document.getElementById("is-select-batch-button").addEventListener("click",a=>{let s,n;a.preventDefault();const i=e=>{e.preventDefault(),t=parseInt(e.currentTarget.getAttribute("data-batch-id"),10),s(),cityssm.postJSON("/plates/doGetLookupBatch",{batchID:t},e=>{f(e),b()})};cityssm.openHtmlModal("mto-selectBatch",{onshow(t){if(n=t.getElementsByClassName("is-results-container")[0],cityssm.postJSON("/plates/doGetUnreceivedLicencePlateLookupBatches",{},e=>{if(0===e.length)return void(n.innerHTML='<div class="message is-info"><p class="message-body">There are no unsent batches available.</p></div>');const t=document.createElement("div");t.className="panel";for(const a of e){const e=document.createElement("a");e.className="panel-block is-block",e.setAttribute("href","#"),e.setAttribute("data-batch-id",a.batchID.toString()),e.innerHTML='<div class="columns"><div class="column is-narrow">#'+a.batchID+'</div><div class="column has-text-right">'+a.batchDateString+'<br /><div class="tags justify-flex-end">'+(a.lockDate?'<span class="tag"><span class="icon is-small"><i class="fas fa-lock" aria-hidden="true"></i></span><span>Locked</span></span>':"")+(a.sentDate?'<span class="tag"><span class="icon is-small"><i class="fas fa-share" aria-hidden="true"></i></span><span>Sent to MTO</span></span>':"")+"</div></div></div>",e.addEventListener("click",i),t.appendChild(e)}cityssm.clearElement(n),n.appendChild(t)}),e){const e=t.getElementsByClassName("is-create-batch-button")[0];e.classList.remove("is-hidden"),e.addEventListener("click",()=>{s(),cityssm.confirmModal("Create a New Batch?","Are you sure you want to create a new licence plate lookup batch?","Yes, Create a Batch","info",()=>{cityssm.postJSON("/plates/doCreateLookupBatch",{},e=>{e.success&&(f(e.batch),b())})})})}},onshown(e,t){s=t}})}),e&&v.addEventListener("click",()=>{if(a)return;cityssm.confirmModal("Lock Batch?",'<strong>Are you sure you want to lock the batch?</strong><br />Once the batch is locked, no licence plates can be added or deleted from the batch. All tickets related to the licence plates in the batch will be updated with a "Pending Lookup" status.',"Yes, Lock the Batch","info",()=>{cityssm.postJSON("/plates/doLockLookupBatch",{batchID:t},e=>{e.success&&f(e.batch)})})}),exports.plateExportBatch&&(f(exports.plateExportBatch),delete exports.plateExportBatch,b())})();