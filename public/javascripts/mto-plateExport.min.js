(function(){function y(a){a.preventDefault();var b=a.currentTarget;b.setAttribute("disabled","disabled");var c=parseInt(b.getAttribute("data-index"));a=p[c];var g=b.closest(".is-plate-container");cityssm.postJSON("/plates/doAddLicencePlateToLookupBatch",{batchID:d,licencePlateCountry:"CA",licencePlateProvince:"ON",licencePlateNumber:a.licencePlateNumber,ticketID:a.ticketIDMin},function(a){a.success?(g.remove(),p[c]=null,k(a.batch)):b.removeAttribute("disabled")})}function z(a){a.preventDefault();
var b=a.currentTarget;b.setAttribute("disabled","disabled");a=parseInt(b.getAttribute("data-index"));a=q[a];var c=b.closest(".is-entry-container");cityssm.postJSON("/plates/doRemoveLicencePlateFromLookupBatch",{batchID:d,licencePlateCountry:"CA",licencePlateProvince:"ON",licencePlateNumber:a.licencePlateNumber},function(a){a.success?(c.remove(),l()):b.removeAttribute("disabled")})}function A(a){a.preventDefault();pts.confirmModal("Clear Batch?","Are you sure you want to remove all licence plates from the batch?",
"Yes, Clear the Batch","warning",function(){cityssm.postJSON("/plates/doClearLookupBatch",{batchID:d},function(a){a.success&&(k(a.batch),l())})})}function B(a){a.preventDefault();a=function(){window.open("/plates/mtoExport/"+d);r=!0};r?a():pts.confirmModal("Download Batch?","<strong>You are about to download this batch for the first time.</strong><br />The date of this download will be tracked as part of the batch record.","OK, Download the File","warning",a)}function C(a,b){return a+'<a class="tag has-tooltip-bottom" data-tooltip="View Ticket (Opens in New Window)" href="/tickets/byTicketNumber/'+
encodeURIComponent(b)+'" target="_blank">'+cityssm.escapeHTML(b)+"</a> "}function u(){cityssm.clearElement(n);var a=document.createElement("div");a.className="panel";for(var b=v.value.toLowerCase().trim().split(" "),c=[],g=0;g<p.length;g+=1){var f=p[g];if(f){for(var m=!0,h=f.licencePlateNumber.toLowerCase(),e=0;e<b.length;e+=1)if(-1===h.indexOf(b[e])){m=!1;break}m&&(c.push([f.licencePlateNumber,f.ticketIDMin]),m=document.createElement("div"),m.className="panel-block is-block is-plate-container",m.innerHTML=
'<div class="level is-marginless">'+('<div class="level-left"><div class="licence-plate"><div class="licence-plate-number">'+cityssm.escapeHTML(f.licencePlateNumber)+"</div></div></div>")+('<div class="level-right"><button class="button is-small" data-index="'+g+'" data-tooltip="Add to Batch" type="button"><span class="icon is-small"><i class="fas fa-plus" aria-hidden="true"></i></span><span>Add</span></button></div>')+'</div><div class="level"><div class="level-left"><div class="tags">'+f.ticketNumbers.reduce(C,
"")+'</div></div><div class="level-right is-size-7">'+f.issueDateMinString+(f.issueDateMin===f.issueDateMax?"":" to "+f.issueDateMaxString)+"</div></div>",m.getElementsByTagName("button")[0].addEventListener("click",y),a.appendChild(m))}}0<c.length?(b=document.createElement("button"),b.className="button is-fullwidth has-margin-bottom-10",b.innerHTML='<span class="icon is-small"><i class="fas fa-plus" aria-hidden="true"></i></span><span>Add '+c.length+" Licence Plate"+(1===c.length?"":"s")+"</span>",
b.addEventListener("click",function(){cityssm.openHtmlModal("loading",{onshown:function(a,b){document.getElementById("is-loading-modal-message").innerText="Adding "+c.length+" Licence Plate"+(1===c.length?"":"s")+"...";cityssm.postJSON("/plates/doAddAllLicencePlatesToLookupBatch",{batchID:d,licencePlateCountry:"CA",licencePlateProvince:"ON",licencePlateNumbers:c},function(a){b();a.success&&(k(a.batch),l())})}})}),n.appendChild(b),n.appendChild(a)):n.innerHTML='<div class="message is-info"><div class="message-body">There are no licence plates that meet your search criteria.</div></div>'}
function D(){cityssm.postJSON("/plates/doGetLookupBatch",{batchID:d},function(a){k(a);l()})}var w="true"===document.getElementsByTagName("main")[0].getAttribute("data-can-update"),d=-1,h=!0,r=!1,k,l,x=document.getElementById("available--issueDaysAgo"),n=document.getElementById("is-available-plates-container"),v=document.getElementById("available--licencePlateNumber"),p=[],q=[];l=function(){h?n.innerHTML='<div class="message is-info"><div class="message-body">Licence Plates cannot be added to a locked batch.</div></div>':
(n.innerHTML='<p class="has-text-centered has-text-grey-lighter"><i class="fas fa-3x fa-circle-notch fa-spin" aria-hidden="true"></i><br /><em>Loading licence plates...</p>',cityssm.postJSON("/plates/mto_doGetPlatesAvailableForLookup",{batchID:d,issueDaysAgo:x.value},function(a){p=a;u()}))};document.getElementById("is-more-available-filters-toggle").addEventListener("click",function(a){a.preventDefault();a=document.getElementById("is-more-available-filters");a.classList.toggle("is-block");a.classList.toggle("is-hidden")});
v.addEventListener("keyup",u);x.addEventListener("change",l);var t=document.getElementById("is-lock-batch-button"),e=document.getElementById("is-batch-entries-container");k=function(a){d=a.batchID;q=a.batchEntries;h=null!=a.lockDate;r=null!=a.sentDate;w&&(h?t.setAttribute("disabled","disabled"):t.removeAttribute("disabled"));document.getElementById("batchSelector--batchID").innerText="Batch #"+a.batchID;document.getElementById("batchSelector--batchDetails").innerHTML='<span class="icon is-small"><i class="fas fa-calendar"></i></span><span>'+
a.batchDateString+"</span>"+(h?' <span class="tag is-light"><span class="icon is-small"><i class="fas fa-lock" aria-hidden="true"></i></span> <span>'+a.lockDateString+"</span></span>":"");cityssm.clearElement(e);if(0===q.length)e.innerHTML='<div class="message is-info"><p class="message-body">There are no licence plates included in the batch.</p></div>';else{cityssm.clearElement(e);a=document.createElement("div");a.className="panel";for(var b=0;b<q.length;b+=1){var c=q[b],g=document.createElement("div");
g.className="panel-block is-block is-entry-container";g.innerHTML='<div class="level">'+('<div class="level-left"><div class="licence-plate"><div class="licence-plate-number">'+cityssm.escapeHTML(c.licencePlateNumber)+"</div></div></div>")+(h?"":'<div class="level-right"><button class="button is-small" data-index="'+b+'" type="button"><span class="icon is-small"><i class="fas fa-minus" aria-hidden="true"></i></span><span>Remove</span></button></div>')+"</div>";h||g.getElementsByTagName("button")[0].addEventListener("click",
z);a.appendChild(g)}h?(b=document.createElement("button"),b.className="button is-fullwidth has-margin-bottom-10",b.innerHTML='<span class="icon is-small"><i class="fas fa-download" aria-hidden="true"></i></span><span>Download File for MTO</span>',b.addEventListener("click",B),e.appendChild(b),e.insertAdjacentHTML("beforeend",'<a class="button is-fullwidth has-margin-bottom-10" href="https://www.apps.rus.mto.gov.on.ca/edtW/login/login.jsp" target="_blank" rel="noreferrer"><span class="icon is-small"><i class="fas fa-building" aria-hidden="true"></i></span><span>MTO ARIS Login</span></a>')):
(b=document.createElement("button"),b.className="button is-fullwidth has-margin-bottom-10",b.innerHTML='<span class="icon is-small"><i class="fas fa-broom" aria-hidden="true"></i></span><span>Clear Batch</span>',b.addEventListener("click",A),e.appendChild(b));e.appendChild(a)}};document.getElementById("is-select-batch-button").addEventListener("click",function(a){a.preventDefault();var b,c,g=function(a){a.preventDefault();d=parseInt(a.currentTarget.getAttribute("data-batch-id"));b();D()},f=function(){cityssm.postJSON("/plates/doGetUnreceivedLicencePlateLookupBatches",
{},function(a){if(0===a.length)c.innerHTML='<div class="message is-info"><p class="message-body">There are no unsent batches available.</p></div>';else{var b=document.createElement("div");b.className="list is-hoverable";for(var f=0;f<a.length;f+=1){var e=a[f],d=document.createElement("a");d.className="list-item";d.setAttribute("href","#");d.setAttribute("data-batch-id",e.batchID);d.innerHTML='<div class="columns"><div class="column is-narrow">#'+e.batchID+'</div><div class="column has-text-right">'+
e.batchDateString+"<br />"+('<div class="tags justify-flex-end">'+(e.lockDate?'<span class="tag"><span class="icon is-small"><i class="fas fa-lock" aria-hidden="true"></i></span><span>Locked</span></span>':"")+(e.sentDate?'<span class="tag"><span class="icon is-small"><i class="fas fa-share" aria-hidden="true"></i></span><span>Sent to MTO</span></span>':"")+"</div>")+"</div></div>";d.addEventListener("click",g);b.appendChild(d)}cityssm.clearElement(c);c.appendChild(b)}})};cityssm.openHtmlModal("mto-selectBatch",
{onshow:function(a){c=a.getElementsByClassName("is-results-container")[0];f()},onshown:function(a,c){b=c}})});w&&(document.getElementById("is-create-batch-button").addEventListener("click",function(){pts.confirmModal("Create a New Batch?","Are you sure you want to create a new licence plate lookup batch?","Yes, Create a Batch","info",function(){cityssm.postJSON("/plates/doCreateLookupBatch",{},function(a){a.success&&(k(a.batch),l())})})}),t.addEventListener("click",function(){h||pts.confirmModal("Lock Batch?",
'<strong>Are you sure you want to lock the batch?</strong><br />Once the batch is locked, no licence plates can be added or deleted from the batch. All tickets related to the licence plates in the batch will be updated with a "Pending Lookup" status.',"Yes, Lock the Batch","info",function(){cityssm.postJSON("/plates/doLockLookupBatch",{batchID:d},function(a){a.success&&k(a.batch)})})}));pts.plateExportBatch&&(k(pts.plateExportBatch),delete pts.plateExportBatch,l())})();
